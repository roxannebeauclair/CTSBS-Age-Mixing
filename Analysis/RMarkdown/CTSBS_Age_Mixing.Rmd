---
title: "CTSBS Age-Mixing"
author: "Roxanne Beauclair"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output: html_document
---

```{r setup, include = FALSE}
# ===================
# Relative file paths
# ===================
wd <- "/Users/roxannebeauclair/Documents/Analytical Projects/PhD/CTSBS Age Mixing/Analysis"
cdata <- paste0(wd, "/Data/Cleaned")

concurdata <- paste0(cdata, "/ctsbs_concur_added_data.rda")
imputedata <- paste0(cdata, "/ctsbs_impute_data.rda")
imputedatapart <- paste0(cdata, "/ctsbs_impute_data_part.rda")

fxn <- paste0(wd, "/Scripts/00-Functions.R")

# ====================
# Loading dependencies
# ====================
source(fxn)

# magrittr: for use of %>% operator
# tidyverse: for data management functions
# mice: for MI


InstallLoad("magrittr", "tidyverse", "mice",
            "nlme", "modelr",
            "mgcv", "broom")

# =============
# Load datasets
# =============
load(imputedata)
load(imputedatapart)
load(concurdata)

# ====================
# Set specific global options
# ====================

# Set theme for plots
theme <- theme(axis.title.x = element_text(face = "bold", size = 10),
             axis.text.x  = element_text(angle = 0, face = "bold",
                                         colour = "black", size = 8),
             axis.title.y = element_text(face = "bold", size = 10),
             axis.text.y = element_text(angle = 0, 
                                        face = "bold", 
                                        colour = "black", 
                                        hjust = 0.5,
                                        size = 8),
             plot.title = element_text(lineheight = .8, face = "bold"),
             panel.grid.major = element_line(colour = 'grey82'),
             panel.grid.minor = element_line(colour = NA),
             panel.background = element_rect(fill = 'white'),
             strip.background = element_rect(fill = 'white'),
             strip.text = element_text(size = 8, face = "bold"),
             legend.title = element_text(colour = "black", size = 9, face = "bold"),
             legend.text = element_text(size = 8, face = "bold"),
             plot.margin = unit(c(1.5,1,1,1), "lines"))


# Initialize table counter
options(show.signif.stars = F)
```


```{r df_description, include = FALSE}
# How many exclusions due to sexuality
df1 <- df %>%
  filter(sexorientation != "Both" | is.na(sexorientation)) %>%
  filter((sex == "Male" & sexorientation == "Women") |
           ((sex == "Female" & sexorientation == "Men")) |
              (is.na(sex))) 

n_sexuality <- nrow(df) - nrow(df1)

# How many exclusions due to race
df2 <- df1 %>%
  filter(race == "Coloured" | 
           race == "Black" |
           is.na(race)) 

n_race <- nrow(df1) - nrow(df2)

# How many exclusions due to no parter reported
df3 <- df2 %>%
  filter(partner != 0) %>%
  droplevels()

n_nopart <- nrow(df2) - nrow(df3)

# How many relationships left
rels_left <- nrow(df3)

# How many participants left
parts_left <- df3 %>%
  distinct(id) %>%
  nrow()

imp <- max(as.integer(dfimp$.imp)) - 1

```

<br>

Before conducting imputations, I excluded participants who said there sexual preferences were for "both" genders or the same gender (n = `r n_sexuality`). I further excluded people who did not identify as black or coloured (n = `r n_race`) and people who did not report partners in the previous year (n = `r n_nopart`). Missing observations on those characteristics were left in the dataset. This left `r rels_left` relationships reported by `r parts_left`. Then I imputed `r imp` datasets using the random forest method for continuous and nominal categorical variables and the "poly" method for our ordinal variables. 

```{r ampfig setup, include = FALSE}

set.seed(47621)
n <- sample(1:imp, 1)

# Smaller datasets
df <- dfimp %>%
  filter(.imp == n) %>%
  select(id, age, agemean, age2sd, agep, sex,
         missage, missagep, hiv) 

men <- df %>%
  filter(sex == "Male")

women <- df %>%
  filter(sex == "Female")


# Now fit separate models for men and women
modelm1 <- lme(agep ~ agemean, 
           data = men, 
           random = ~1 | id,  
           #weights = varPower(value = 0.5, form = ~agemean + 1),
           method = "REML")

modelw1 <- lme(agep ~ agemean, 
           data = women, 
           random = ~1 | id,  
           #weights = varPower(value = 0.5, form = ~agemean + 1),
           method = "REML")

modelm2 <- gamm(agep ~ s(agemean), 
           data = men, 
           random = list(id = ~1))

modelw2 <- gamm(agep ~ s(agemean), 
           data = women, 
           random = list(id = ~1))


# Add the predicted values to the dataset
menadd <- men %>%
  mutate(pred.1 = predict(modelm1, newdata = ., level = 0),
         pred.2 = predict(modelm2$gam, newdata = .),
         resid.2 = residuals(modelm2$gam)) %>%
  add_residuals(modelm1, var = "resid.1")

womenadd <- women %>%
  mutate(pred.1 = predict(modelw1, newdata = ., level = 0),
         pred.2 = predict(modelw2$gam, newdata = .),
         resid.2 = residuals(modelw2$gam))%>%
  add_residuals(modelw1, var = "resid.1") 

#Combine both datasets again
comb <- bind_rows(menadd, womenadd) %>%
  gather(key, value, -id:-hiv) %>%
  separate(key, into = c("type", "model"), sep = "\\.")
  
```

```{r ampfig, echo = FALSE}

ampfig <- comb %>%
  filter(type == "pred") %>%
  ggplot(aes(x = age, y = value)) +
  geom_point(aes(x = age, 
                 y = agep, 
                 color = missagep), 
             position = position_jitter(width = 0.75, height = 0.75),
             size = 1) +
  geom_abline(size = 1, 
              aes(intercept = 0, slope = 1, linetype = "Same age"), 
              show.legend = FALSE) +
  geom_line(aes(linetype = "Population mean"), 
            size = 1) +
  facet_wrap(model ~ sex) + 
  scale_y_continuous(name = "Partner's ages") +
  scale_color_manual('Imputation Status', values = c('grey70', 'grey42')) +
  scale_linetype_manual('Lines', values = c("Population mean" = 1, 'Same age' = 2)) +
  xlab("Participant's age (centered on mean age)") +
  guides(linetype = guide_legend(keywidth = 2, keyheight = 1)) +
  theme

ampfig

```

```{r ampres, echo = FALSE}
ampresfig1 <- comb %>%
  filter(type == "resid") %>%
  ggplot(aes(value)) +
  geom_freqpoly(binwidth = 0.5) +
  facet_grid(model ~ sex) +
  theme

ampresfig1

ampresfig2 <- comb %>%
  filter(type == "resid") %>%
  ggplot(aes(x = age, y = value)) +
  geom_point() +
  geom_smooth(method = "loess") +
  geom_ref_line(h = 0) +
  facet_grid(model ~ sex) + 
  theme

ampresfig2

```

```{r amp_all, include = FALSE}

byimpsex <- dfimp %>% 
  filter(.imp != 0) %>%
  group_by(.imp, sex) %>%
  nest()

tidysummary <- byimpsex %>% # A model will be applied to all imputations and sex
  mutate(model = map(data, ampmodel), #ampmodel is function for nlme amp model
         modelsum = map(model, ~tidy(.x, effects = "fixed")), # Obtaining all the B's and intercepts from the models
         bvar = map(model, bvar), # Obtaining between subject variance using function bvar
         wvar = map(model, wvar)) # Obtaining within subject variance using function wvar

modslopeint <- tidysummary %>%
  unnest(modelsum, .drop = TRUE)

modwvar <- tidysummary %>%
  unnest(wvar, .drop = TRUE)

modbvar <- tidysummary %>%
  unnest(bvar, .drop = TRUE)

```

```{r amp_model_plots, echo = FALSE}

slopeplot <- modslopeint %>%
  filter(term == "agemean") %>%
  ggplot(aes(x = .imp, y = estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Slope of regression line") +
  theme

slopeplot

interplot <- modslopeint %>%
  filter(term == "(Intercept)") %>%
  ggplot(aes(.imp, estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Partner age for average age") +
  theme

interplot

wvarplot <- modwvar %>%
  ggplot(aes(.imp, wsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprwsd,
                      ymin = lwrwsd)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Within-Subject SD") +
  theme

wvarplot

bvarplot <- modbvar %>%
  ggplot(aes(.imp, bsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprbsd,
                      ymin = lwrbsd)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Between-Subject SD") +
  theme

bvarplot
```

```{r ageprop_hiv, echo = FALSE}
hivbyage <- byimpsex %>%
  unnest() %>%
  filter(.imp == n & hiv == "Positive") %>%
  group_by(sex, agepgroup) %>%
  summarise(n = n()) %>%
  mutate(prop = round((n / sum(n)) * 100, 2))
  
hivplot <- hivbyage %>%
  ggplot(aes(x = agepgroup, y = prop, fill = sex)) +
  geom_bar(stat = "identity",
           position = position_dodge()) +
  xlab("Age group of partner") +
  ylab("Proportion of relationships") +
  scale_fill_brewer(palette = "Dark2") +
  theme

hivplot
  
```

```{r hivampfig setup, include = FALSE}

# Smaller datasets
menhiv <- df %>%
  filter(sex == "Male" & hiv == "Positive")

womenhiv <- df %>%
  filter(sex == "Female" & hiv == "Positive")


# Now fit separate models for men and women
modelmhiv <- lme(agep ~ agemean, 
           data = menhiv, 
           random = ~1 | id,  
           method = "REML")

modelwhiv <- lme(agep ~ agemean, 
           data = womenhiv, 
           random = ~1 | id,
           method = "REML")


# Add the predicted values to the dataset
menhivadd <- men %>%
  mutate(pred = predict(modelmhiv, newdata = ., level = 0))

womenhivadd <- women %>%
  mutate(pred = predict(modelwhiv, newdata = ., level = 0)) 

#Combine both datasets again
comb <- bind_rows(menhivadd, womenhivadd) 
  
```

```{r hivampfig, echo = FALSE}

hivampfig <- comb %>%
  ggplot(aes(x = age, y = pred)) +
  geom_point(aes(x = age, 
                 y = agep, 
                 color = missagep), 
             position = position_jitter(width = 0.75, height = 0.75),
             size = 1) +
  geom_abline(size = 1, 
              aes(intercept = 0, slope = 1, linetype = "Same age"), 
              show.legend = FALSE) +
  geom_line(aes(linetype = "Population mean"), 
            size = 1) +
  facet_wrap(~ sex) + 
  scale_y_continuous(name = "Partner's ages") +
  scale_color_manual('Imputation Status', values = c('grey70', 'grey42')) +
  scale_linetype_manual('Lines', values = c("Population mean" = 1, 'Same age' = 2)) +
  xlab("Participant's age") +
  guides(linetype = guide_legend(keywidth = 2, keyheight = 1)) +
  theme

hivampfig

```

```{r bw_hiv_setup}

# Determine the degrees of freedom for the age spline in model
# Randomly select one dataset
set.seed(5555)
n_bw <- sample(1:imp, 1)

partdf <- partdfimp %>%
  filter(.imp == n_bw)

bwmodelm1 <- gam(bridgewidth ~ hiv + s(age) + job,
                 data = partdf,
                 family = nb()) #edf is rounded to 2


# Exclude complete cases dataframe
byimpsex <- partdfimp %>% 
  filter(.imp != 0) %>%
  group_by(.imp, sex) 

# Summarize the median and IQR by sex and dataset
# Among those with more than 1 partner
bwbyimpsex <- byimpsex %>%
  filter(relcount > 1) %>%
  summarise(n = n(),
            Median = median(bridgewidth),
            lwr = summary(bridgewidth)[[2]],
            upr = summary(bridgewidth)[[5]])

# Nest all the datasets by sex and imputation
impsex <- byimpsex %>% 
  nest()
 
tidysummary <- impsex %>% # A model will be applied to all imputations and sex
  mutate(model = map(data, ~ bwmodel(.x, edf = 2)), #bwmodel is function for nb bw model
         modelsum = map(model, tidy))

bwmodcoef <- tidysummary %>%
  unnest(modelsum, .drop = TRUE) %>%
  ungroup() %>%
  mutate(lwr = estimate - 2 * std.error,
         upr = estimate + 2 * std.error,
         irr = exp(estimate),
         lwrirr = exp(lwr),
         uprirr = exp(upr))


# Pool coefficients with mice functions
part <- partdfimp %>%
  filter(relcount > 1) %>%
  as.mids() 

men <- part %>%
  with(glm.nb(bridgewidth ~ hiv + splines::ns(age, 2) + race + job,
              subset = (sex == "Male"))) %>%
  pool() %>%
  summary() %>%
  exp() %>%
  round(2) 

women <- part %>%
  with(glm.nb(bridgewidth ~ hiv + splines::ns(age, 2) + race + job,
              subset = (sex == "Female"))) %>%
  pool() %>%
  summary() %>%
  exp() %>%
  round(2) 

menEBRW <- men[2, 1]
menEBRWlwr <- men[2, 6]
menEBRWupr <- men[2, 7]
womenEBRW <- women[2, 1]
womenEBRWlwr <- women[2, 6]
womenEBRWupr <- women[2, 7]
```

<br>

The expected difference in log count of bridgewidth between those HIV positive and those HIV negative. The expected log count of bw for those with HIV is XX higher than those who are negative.

```{r bw_density, include = FALSE}

bwfig1 <- byimpsex %>%
  ggplot(aes(x = bridgewidth, group = .imp)) +
  geom_density(adjust = 2) +
  facet_grid(hiv ~ sex) +
  xlab("Bridgewidth") +
  ylab("Density") +
   #guides(color = guide_legend("Transmission Probability", size = 1)) +
  theme

bwfig1

hivbwfig1 <- bwmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, irr)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprirr,
                      ymin = lwrirr)) +
  geom_hline(yintercept = 1) +
  facet_grid(sex ~ .) +
  # coord_flip() +
  xlab("Imputation") +
  ylab("Expected Bridge Width Ratio") +
  scale_y_log10() +
  annotate("text", x = 43, y = 7, label = c("Pooled EBWR: 1.52 (0.59-3.91)", 
                                            "Pooled EBRW: 2.67 (1.14-6.23)")) +
  theme

hivbwfig1


```


```{r close, include = FALSE}
# ====================================================
# Detach libraries and remove objects from environment
# ====================================================
Vectorize(detach)(name = paste0("package:", c("magrittr", "tidyverse", "mice",
                                              "mgcv", "nlme", "modelr", "broom")), 
                  unload = TRUE, 
                  character.only = TRUE)

rm(list=ls())

```

