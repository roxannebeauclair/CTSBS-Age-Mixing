---
title: "CTSBS Age-Mixing"
author: "Roxanne beauclair"
date: '`r format(Sys.Date(), "%d %b %Y")`'
output: html_document
---

```{r setup, include = FALSE}
# ===================
# Relative file paths
# ===================
wd <- "/Users/roxannebeauclair/Documents/Analytical Projects/PhD/CTSbS Age Mixing/Analysis"
cdata <- paste0(wd, "/Data/Cleaned")

concurdata <- paste0(cdata, "/ctsbs_concur_added_data.rda")
imputedata <- paste0(cdata, "/ctsbs_impute_data.rda")
imputedatapart <- paste0(cdata, "/ctsbs_impute_data_part.rda")

fxn <- paste0(wd, "/Scripts/00-Functions.R")

# ====================
# Loading dependencies
# ====================
source(fxn)

# magrittr: for use of %>% operator
# tidyverse: for data management functions
# mice: for MI


InstallLoad("magrittr", "MASS", "tidyverse", 
            "mice","nlme", "lme4", "modelr",
            "mgcv", "gamm4", "broom", "splines", 
            "mediation", "forcats")

# =============
# Load datasets
# =============
load(imputedata)
load(imputedatapart)
load(concurdata)

# ====================
# Set specific global options
# ====================

# Set theme for plots
theme <- theme(axis.title.x = element_text(face = "bold", size = 10),
             axis.text.x  = element_text(angle = 0, face = "bold",
                                         colour = "black", size = 8),
             axis.title.y = element_text(face = "bold", size = 10),
             axis.text.y = element_text(angle = 0, 
                                        face = "bold", 
                                        colour = "black", 
                                        hjust = 0.5,
                                        size = 8),
             plot.title = element_text(lineheight = .8, face = "bold"),
             panel.grid.major = element_line(colour = 'grey82'),
             panel.grid.minor = element_line(colour = NA),
             panel.background = element_rect(fill = 'white'),
             strip.background = element_rect(fill = 'white'),
             strip.text = element_text(size = 8, face = "bold"),
             legend.title = element_text(colour = "black", size = 9, face = "bold"),
             legend.text = element_text(size = 8, face = "bold"),
             plot.margin = unit(c(1.5,1,1,1), "lines"))


# Initialize table counter
options(show.signif.stars = F)
```


```{r df_description, include = FALSE}
# How many exclusions due to sexuality
df1 <- df %>%
  filter(sexorientation != "both" | is.na(sexorientation)) %>%
  filter((sex == "Male" & sexorientation == "Women") |
           ((sex == "Female" & sexorientation == "Men")) |
              (is.na(sex))) 

n_sexuality <- nrow(df) - nrow(df1)

# How many exclusions due to race
df2 <- df1 %>%
  filter(race == "Coloured" | 
           race == "Black" |
           is.na(race)) 

n_race <- nrow(df1) - nrow(df2)

# How many exclusions due to no parter reported
df3 <- df2 %>%
  filter(partner != 0) 

n_nopart <- nrow(df2) - nrow(df3)

# How many relationships left
rels_left <- nrow(df3)

# How many participants left
parts_left <- df3 %>%
  distinct(id) %>%
  nrow()

imp <- max(as.integer(dfimp$.imp)) - 1

# How many relationships started in the last year
df4 <- df3 %>%
  mutate(start = as.factor(ifelse(!is.na(start), "Last year", "before last year"))) %>%
  filter(start == "Last year")

rels_last_year <- nrow(df4)

# How many participants had more than 1 relationship
df5 <- partdfimp %>%
  filter(.imp ==23) %>%
  filter(relcount > 1)

parts_many_partner <- nrow(df5)

rm(df, df1, df2, df3, df4, df5)

```

<br>

**Research question:** 

1. Describe the age-mixing pattern in the CTSBS population.
2. 

Before conducting imputations, I excluded participants who said their sexual preferences were for "both" genders or the same gender (n = `r n_sexuality`). I further excluded people who did not identify as black or coloured (n = `r n_race`) and people who did not report partners in the previous year (n = `r n_nopart`). Participants who had missing observations on those characteristics were left in the dataset. This left `r rels_left` relationships reported by `r parts_left` participants. Of the `r parts_left` participants, `r parts_many_partner` reported more than one relationship in the previous year. I imputed `r imp` datasets using the random forest method for continuous and nominal categorical variables and the "polr" method for our ordinal variables. 

```{r amp_setup, include = FALSE}

# What is the age mixing pattern?
set.seed(47621)
n <- sample(1:imp, 1)

# Smaller datasets
dfamp <- dfimp %>%
  filter(.imp == n) %>%
  select(id, age, age0, agep, sex,
         missage, missagep, hiv) 

dfampm <- dfamp %>%
  filter(sex == "Male")

dfampw <- dfamp %>%
  filter(sex == "Female")


# Now fit separate models for men and women
ampmodm1 <- lme(agep ~ age0, 
           data = dfampm, 
           random = ~1 | id,  
           method = "REML")

ampmodw1 <- lme(agep ~ age0, 
           data = dfampw, 
           random = ~1 | id,
           method = "REML")

# Add the predicted values and residuals to the dataset
dfampm <- dfampm %>%
  mutate(pred = predict(ampmodm1, newdata = ., level = 0)) %>%
  add_residuals(ampmodm1, var = "resid")

dfampw <- dfampw %>%
  mutate(pred = predict(ampmodw1, newdata = ., level = 0)) %>%
  add_residuals(ampmodw1, var = "resid") 

#Combine both datasets again
comb <- bind_rows(dfampm, dfampw) 
  
```

<br>

###### **Figure 1. Age mixing pattern for randomly selected imputed dataset. Linear mixed effects model without hetero skedastic variance explicitly modeled**

<br>

```{r amp_fig, echo = FALSE}
# Figure visualizing the age mixing pattern
ampfig <- comb %>%
  ggplot(aes(x = age, y = pred)) +
  geom_point(aes(x = age, 
                 y = agep, 
                 color = missagep), 
             position = position_jitter(width = 0.75, height = 0.75),
             size = 1) +
  geom_abline(size = 1, 
              aes(intercept = 0, slope = 1, linetype = "Same age"), 
              show.legend = FALSE) +
  geom_line(aes(linetype = "Population mean"), 
            size = 1) +
  facet_grid(~ sex) + 
  scale_y_continuous(name = "Partner's ages") +
  scale_color_manual('Imputation Status', values = c('grey70', 'grey42')) +
  scale_linetype_manual('Lines', values = c("Population mean" = 1, 'Same age' = 2)) +
  xlab("Participant's age") +
  guides(linetype = guide_legend(keywidth = 2, keyheight = 1)) +
  theme

ampfig

```

<br>

###### **Figure 2. 2A visualizes the spread of the residuals for the different models. Model 1 is the linear mixed effect model with age as a linear term, while Model 2 is a GAMM. 2b visualizes the pattern of residuals for the lme and gamm. In both models there appears to be constant variance**

<br>

```{r amp_res_fig, include = FALSE}
# Visualizing spread of residuals for lm 
ampresfig1 <- comb %>%
  ggplot(aes(resid)) +
  geom_freqpoly(binwidth = 0.5) +
  facet_grid(. ~ sex) +
  theme

ampresfig1

# Visualizing pattern of residuals for lm 
ampresfig2 <- comb %>%
  ggplot(aes(x = age, y = resid)) +
  geom_point() +
  geom_smooth(method = "loess") +
  geom_ref_line(h = 0) +
  facet_grid(. ~ sex) + 
  theme

ampresfig2

```

```{r amp_all_setup, include = FALSE}

# Create a dataset that nests all of the datasets according to
# gender and imputation. So with 2 genders and 50 imps, there will be
# 100 groups/dataframes
impsexamp <- dfimp %>% 
  filter(.imp != 0) %>%
  group_by(.imp, sex) %>%
  nest()

# Produce nice summary of the models
tidysumamp <- impsexamp %>% # A model will be applied to all imputations and sex
  mutate(model = map(data, ampmodel), #ampmodel is function for nlme amp model
         modelsum = map(model, ~tidy(.x, effects = "fixed")), # Obtaining all the b's and intercepts from the models
         bvar = map(model, bvar), # Obtaining between subject variance using function bvar
         wvar = map(model, wvar)) # Obtaining within subject variance using function wvar

# Unnest tidy summary for data on slope and intercept
# of all the models
modslopeint <- tidysumamp %>%
  unnest(modelsum, .drop = TRUE)

# Unnest tidy summary for data on within individual variance
modwvar <- tidysumamp %>%
  unnest(wvar, .drop = TRUE)

# Uneest tidy summary for data on between individual variance
modbvar <- tidysumamp %>%
  unnest(bvar, .drop = TRUE)

```

<br>

###### **Figure 3. Extractions of model slopes, intercepts, intercept variance and residual variance for each imputed dataset**

<br>

```{r amp_model_plots, echo = FALSE}

# Plot all of the beta's for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
slopeplot <- modslopeint %>%
  filter(term == "agemean") %>%
  ggplot(aes(x = .imp, y = estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Slope of regression line") +
  theme

slopeplot

# Plot all of the intercepts for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
interplot <- modslopeint %>%
  filter(term == "(Intercept)") %>%
  ggplot(aes(.imp, estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Partner age for average age") +
  theme

interplot

# Plot each of the residual variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
wvarplot <- modwvar %>%
  ggplot(aes(.imp, wsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprwsd,
                      ymin = lwrwsd)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Within-Subject SD") +
  theme

wvarplot

# Plot each of the between subject variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
bvarplot <- modbvar %>%
  ggplot(aes(.imp, bsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprbsd,
                      ymin = lwrbsd)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("between-Subject SD") +
  theme

bvarplot
```

<br>

###### **Figure 4. Fraction of relationships with different partner age groups, among those who are HIV positive**

<br>

```{r age_hiv_fig, echo = FALSE}
# Create dataframe that summarizes the proportion of relationships
# in different partner age groups for people who are HIV
# positive
hivbyage <- impsexamp %>%
  unnest() %>%
  ungroup() %>%
  filter(.imp == n & hiv == "Positive") %>%
  group_by(sex, agepgroup) %>%
  summarise(n = n()) %>%
  mutate(prop = round((n / sum(n)) * 100, 2))

# barplot of fraction of relationships in different partner age groups  
hivageplot <- hivbyage %>%
  ggplot(aes(x = agepgroup, y = prop, fill = sex)) +
  geom_bar(stat = "identity",
           position = position_dodge()) +
  xlab("Age group of partner") +
  ylab("Proportion of relationships") +
  scale_fill_brewer(palette = "Dark2") +
  theme

hivageplot
  
```

```{r amp_hiv_fig_setup, include = FALSE}
# This chunk sets up the data in order to visualize the age 
# mixing pattern among those who are HIV positive

# Smaller datasets
dfamphivm <- dfamp %>%
  filter(sex == "Male" & hiv == "Positive")

dfamphivw <- dfamp %>%
  filter(sex == "Female" & hiv == "Positive")


# Now fit separate models for men and women
amphivmodm <- lme(agep ~ agemean, 
           data = dfamphivm, 
           random = ~1 | id,  
           method = "REML")

amphivmodw <- lme(agep ~ agemean, 
           data = dfamphivw, 
           random = ~1 | id,
           method = "REML")


# Add the predicted values to the dataset
dfamphivm <- dfamphivm %>%
  mutate(pred = predict(amphivmodm, newdata = ., level = 0))

dfamphivw <- dfamphivw %>%
  mutate(pred = predict(amphivmodw, newdata = ., level = 0)) 

#Combine both datasets again
comb <- bind_rows(dfamphivm, dfamphivw) 
  
```

<br>

###### **Figure 5. Age mixing pattern for those who are HIV positive**

<br>

```{r amp_hiv_fig, echo = FALSE}
# Visualizing the age mixing pattern among those
# who are HIV positive
amphivfig <- comb %>%
  ggplot(aes(x = age, y = pred)) +
  geom_point(aes(x = age, 
                 y = agep, 
                 color = missagep), 
             position = position_jitter(width = 0.75, height = 0.75),
             size = 1) +
  geom_abline(size = 1, 
              aes(intercept = 0, slope = 1, linetype = "Same age"), 
              show.legend = FALSE) +
  geom_line(aes(linetype = "Population mean"), 
            size = 1) +
  facet_wrap(~ sex) + 
  scale_y_continuous(name = "Partner's ages") +
  scale_color_manual('Imputation Status', values = c('grey70', 'grey42')) +
  scale_linetype_manual('Lines', values = c("Population mean" = 1, 'Same age' = 2)) +
  xlab("Participant's age") +
  guides(linetype = guide_legend(keywidth = 2, keyheight = 1)) +
  theme

amphivfig

```


```{r bw_hiv_setup, include = FALSE}
# Exclude complete cases dataframe
# Keep only participants with more than one relationship in the past year
impsex <- partdfimp %>% 
  filter(.imp != 0) %>%
  mutate(cf = fct_collapse(partcf,
                           "Never/inconsistent" = c("Never", "Inconsistent"))) %>%
  group_by(.imp, sex) 

# Summarize the median and IQR of bW by sex and dataset
# Among those with more than 1 partner
bwbyimpsex <- impsex %>%
  filter(relcount > 1) %>%
  summarise(n = n(),
            Median = median(bridgewidth),
            lwr = summary(bridgewidth)[[2]],
            upr = summary(bridgewidth)[[5]])

# Nest all the datasets by sex and imputation
impsexbw <- impsex %>% 
  filter(relcount > 1) %>%
  nest()

# Does HIV predict bridgewidths (neg bin models)?
# Does HIV predict whether a participant had a concurrent rel in past year (logistic models)?

tidysum <- impsexbw %>% # A model will be applied to all imputations and sex
  mutate(modelbw = map(data, bwmodel), # bwmodel is function for nb bw model, model as stored as var in nested df
         modelmcp = map(data, mcpmodel),
         modelmcpbw = map(data, mcpbwmodel),
         modelmcpfull = map(data, ~mcpmodel(.x, med = TRUE)),
         modelsumbw = map(modelbw, tidygam), # Create tidy summary of each model and store as modelsum var in nested df
         modelsummcp = map(modelmcp, tidygam),
         modelsumbwmcp = map(modelmcpbw, tidygam),
         modelsummcpfull = map(modelmcpfull, tidygam),
         predsbwage = map2(modelbw, data, ~gampreds(.x, .y, xvar = "age")), # Create predictions across dif vals of age (our spline var) 
         predsmcpage = map2(modelmcp, data, ~gampreds(.x, .y, xvar = "age")),
         predsbwmcpage = map2(modelmcpbw, data, ~gampreds(.x, .y, xvar = "age")),
         predsmcpfullage = map2(modelmcpfull, data, ~gampreds(.x, .y, xvar = "age")))

# Unnest the tidy summary, to see the tidy model estimates for each model
bwmodcoef <- tidysum %>%
  unnest(modelsumbw, .drop = TRUE) 

mcpmodcoef <- tidysum %>%
  unnest(modelsummcp, .drop = TRUE)

mcpbwmodcoef <- tidysum %>%
  unnest(modelsumbwmcp, .drop = TRUE)

mcpfullmodcoef <- tidysum %>%
  unnest(modelsummcpfull, .drop = TRUE)

# Unnest the tidy summary, to see the tidy model predictions for values of age
# for each model
bwmodpredage <- tidysum %>%
  unnest(predsbwage, .drop = TRUE)

mcpmodpredage <- tidysum %>%
  unnest(predsmcpage, .drop = TRUE)

mcpbwmodpredage <- tidysum %>%
  unnest(predsbwmcpage, .drop = TRUE)

mcpfullmodpredage <- tidysum %>%
  unnest(predsmcpfullage, .drop = TRUE)

```


```{r sb_hiv_setup, include = FALSE, cache = TRUE}
# Exclude complete cases dataframe
# Keep only participants with more than one relationship in the past year
# Relationship-level sex behaviours
impsexsb <- dfimp %>% 
  filter(.imp != 0 & 
           relcount > 1) %>%
  mutate(cf = fct_collapse(relcf,
                           "Never/inconsistent" = c("Never", "Inconsistent"))) %>%
  group_by(.imp, sex) %>%
  nest()

# Does HIV predict condom use in relationships among people who had more than one relationships?
# Does HIV predict sex freq in relationships among people who had more than one relationship?

# Model must use lmer (instead of lme) because of mediation analyis (if mediate is used)

tidysummed <- impsexsb %>%
  mutate(modelcf = map(data, cfmodel),
         modelcfbw = map(data, cfbwmodel),
         modelcffull = map(data, ~cfmodel(.x, med = TRUE)),
         modelsf = map(data, sfmodel),
         modelsfbw = map(data, sfbwmodel),
         modelsffull = map(data, ~sfmodel(.x, med = TRUE)),
         modelsumcf = map(modelcf, tidygam),
         modelsumcfbw = map(modelcfbw, tidygam),
         modelsumcffull = map(modelcffull, tidygam),
         modelsumsf = map(modelsf, tidygam),
         modelsumsfbw = map(modelsfbw, tidygam),
         modelsumsffull = map(modelsffull, tidygam),
         predcfage = map2(modelcf, data, ~gampreds(.x, .y, xvar = "age")),
         predcfbwage = map2(modelcfbw, data, ~gampreds(.x, .y, xvar = "age")),
         predcffullage = map2(modelcffull, data, ~gampreds(.x, .y, xvar = "age")),
         predsfage = map2(modelsf, data, ~gampreds(.x, .y, xvar = "age")),
         predsfbwage = map2(modelsfbw, data, ~gampreds(.x, .y, xvar = "age")),
         predsffullage = map2(modelsffull, data, ~gampreds(.x, .y, xvar = "age")))

tidysummed


# Unnest the tidy gam cf summary, to see tidy model estimates
cfmodcoef <- tidysummed %>%
  unnest(modelsumcf, .drop = TRUE)

cfmodcoef

# Unnest the tidy gam sf summary, to see tidy model estimates
sfmodcoef <- tidysummed %>%
  unnest(modelsumsf, .drop = TRUE)

sfmodcoef

# Unnest the tidy gam cfbw summary, to see tidy model estimates
cfbwmodcoef <- tidysummed %>%
  unnest(modelsumcfbw, .drop = TRUE)

cfbwmodcoef

# Unnest the tidy gam sfbw summary, to see tidy model estimates
sfbwmodcoef <- tidysummed %>%
  unnest(modelsumsfbw, .drop = TRUE)

sfbwmodcoef

# Unnest the tidy gam full cf summary, to see tidy model estimates
cffullmodcoef <- tidysummed %>%
  unnest(modelsumcffull, .drop = TRUE)

cffullmodcoef

# Unnest the tidy gam full sf summary, to see tidy model estimates
sffullmodcoef <- tidysummed %>%
  unnest(modelsumsffull, .drop = TRUE)

sffullmodcoef

# Unnest the tidy summary, to see the tidy model predictions for values of age
# for each gamm model
cfmodpredage <- tidysummed %>%
  unnest(predcfage, .drop = TRUE)

cfmodpredage


sfmodpredage <- tidysummed %>%
  unnest(predsfage, .drop = TRUE)

sfmodpredage


cfbwmodpredage <- tidysummed %>%
  unnest(predcfbwage, .drop = TRUE)

cfbwmodpredage


sfbwmodpredage <- tidysummed %>%
  unnest(predsfbwage, .drop = TRUE)

sfbwmodpredage

cffullmodpredage <- tidysummed %>%
  unnest(predcffullage, .drop = TRUE)

cffullmodpredage


sffullmodpredage <- tidysummed %>%
  unnest(predsffullage, .drop = TRUE)

sffullmodpredage
```


```{r pool_bw_coef, include = FALSE}

# Now we want to produce a pooled beta for HIV according to 
# Rubin's rules. To do this we use mice functions

part <- partdfimp %>% # Take original participant-level imputed df
   filter(relcount > 1) %>% # Only participants who had more than one rel
   as.mids() # Create mids object
 
bwmodpoolm <- part %>%
   with(
     gam(bridgewidth ~ hiv + s(age) + race,
         family = nb(),
         subset = (sex == "Male"))
     ) %>%
   pool() %>% # Pool coefficients according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
bwmodpoolw <- part %>%
   with(
     gam(bridgewidth ~ hiv + s(age) + race,
         family = nb(),
         subset = (sex == "Female"))
     ) %>%
   pool() %>% # Pool according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 

mcpmodpoolm <- part %>%
   with(
     gam(partconcur ~ hiv + s(age) + race,
         family = binomial,
         subset = (sex == "Male"))
     ) %>%
   pool() %>% # Pool coefficients according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
mcpmodpoolw <- part %>%
   with(
     gam(partconcur ~ hiv + s(age) + race,
         family = binomial,
         subset = (sex == "Female"))
     ) %>%
   pool() %>% # Pool according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 

mcpbwmodpoolm <- part %>%
   with(
     gam(partconcur ~ bridgewidth + s(age) + race,
         family = binomial,
         subset = (sex == "Male"))
     ) %>%
   pool() %>% # Pool coefficients according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
mcpbwmodpoolw <- part %>%
   with(
     gam(partconcur ~ bridgewidth + s(age) + race,
         family = binomial,
         subset = (sex == "Female"))
     ) %>%
   pool() %>% # Pool according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 

mcpfullmodpoolm <- part %>%
   with(
     gam(partconcur ~ bridgewidth + s(age) + hiv + race,
         family = binomial,
         subset = (sex == "Male"))
     ) %>%
   pool() %>% # Pool coefficients according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
mcpfullmodpoolw <- part %>%
   with(
     gam(partconcur ~ bridgewidth + s(age) + hiv + race,
         family = binomial,
         subset = (sex == "Female"))
     ) %>%
   pool() %>% # Pool according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
 menEBWR <- bwmodpoolm[2, 1] # Extract HIV EBWR 
 menEBWRlwr <- bwmodpoolm[2, 6] # Extract HIV lower CI limit
 menEBWRupr <- bwmodpoolm[2, 7] # Extract HIV upper CI limit
 womenEBWR <- bwmodpoolw[2, 1]
 womenEBWRlwr <- bwmodpoolw[2, 6]
 womenEBWRupr <- bwmodpoolw[2, 7]
 
 menor <- mcpmodpoolm[2, 1]  
 menorlwr <- mcpmodpoolm[2, 6] 
 menorupr <- mcpmodpoolm[2, 7] 
 womenor <- mcpmodpoolw[2, 1]
 womenorlwr <- mcpmodpoolw[2, 6]
 womenorupr <- mcpmodpoolw[2, 7]
 
 
 mcpbwmenor <- mcpbwmodpoolm[2, 1]  
 mcpbwmenorlwr <- mcpbwmodpoolm[2, 6] 
 mcpbwmenorupr <- mcpbwmodpoolm[2, 7] 
 mcpbwwomenor <- mcpbwmodpoolw[2, 1]
 mcpbwwomenorlwr <- mcpbwmodpoolw[2, 6]
 mcpbwwomenorupr <- mcpbwmodpoolw[2, 7]
 
 # BW
 mcpfullbwmenor <- mcpfullmodpoolm[2, 1]  
 mcpfullbwmenorlwr <- mcpfullmodpoolm[2, 6] 
 mcpfullbwmenorupr <- mcpfullmodpoolm[2, 7] 
 mcpfullbwwomenor <- mcpfullmodpoolw[2, 1]
 mcpfullbwwomenorlwr <- mcpfullmodpoolw[2, 6]
 mcpfullbwwomenorupr <- mcpfullmodpoolw[2, 7]
 
 # HIV
 mcpfullhivmenor <- mcpfullmodpoolm[3, 1]  
 mcpfullhivmenorlwr <- mcpfullmodpoolm[3, 6] 
 mcpfullhivmenorupr <- mcpfullmodpoolm[3, 7] 
 mcpfullhivwomenor <- mcpfullmodpoolw[3, 1]
 mcpfullhivwomenorlwr <- mcpfullmodpoolw[3, 6]
 mcpfullhivwomenorupr <- mcpfullmodpoolw[3, 7]
 

 
```

<br>

####### **Figure 6. Distribution of bridge widths for each imputed dataset, by sex and HIV status**

<br>

```{r bw_density_fig, echo = FALSE}

# Check spread of bridgwidths for each grouped dataset
bwfig <- impsex %>%
  ggplot(aes(x = bridgewidth, group = .imp)) +
  geom_density(adjust = 2) +
  facet_grid(hiv ~ sex) +
  xlab("bridgewidth") +
  ylab("Density") +
  theme

bwfig
```

<br>

###### **Figure 7. Model coefficients for relationship between HIV and bridge width. Results from negative binomial, generalized additive models with bridge width as the outcome. This is only among participants who reported more than 1 relationship in the previous year. Models adjust for race and age.**

<br>

```{r bw_hiv_fig, echo = FALSE}

ticks <- c(0.5, 1.0, 2.0, 4.0)

 label <- c(
   paste0("Pooled EBWR: ", menEBWR, "(", menEBWRlwr, "-", menEBWRupr, ")"),
   paste0("Pooled EBWR: ", womenEBWR, "(", womenEBWRlwr, "-", womenEBWRupr, ")")
 )

# Plot all the b's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
bwhivfig <- bwmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("Expected Bridge Width Ratio") +
  scale_y_log10(breaks = ticks) +
   annotate("text", x = 40, y = 6.5, label = label) +
  theme

bwhivfig
```


<br>

###### **Figure 8. Expected bridge widths for different values of age (smooth term), by gender. Each line represents a different imputed dataset. These curves represent typical values of race (black) and hiv status (negative)**

<br>

```{r bw_age_fig, echo = FALSE}

# Plot expected BW's for different values of age (or spline variable)
# Spaghetti plot to show each line for dataset by gender
bwagefig <- bwmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Expected Bridge Width") +
  theme

bwagefig

```

<br>

###### **Figure 9. Effect of HIV on whether a participant had a concurrent relationship in the previous year, stratified by gender. Odds Ratios (ORs) are from generalized additive models. Models are adjusted for age (smooth term) and race.** 

<br>

```{r mcp_hiv_fig, echo = FALSE}

ticks <- c(0.5, 1.0, 2.0, 4.0)

 label <- c(
   paste0("Pooled OR: ", menor, "(", menorlwr, "-", menorupr, ")"),
   paste0("Pooled OR: ", womenor, "(", womenorlwr, "-", womenorupr, ")")
 )

# Plot all the b's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
mcphivfig <- mcpmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("OR") +
  scale_y_log10(breaks = ticks,
                limits = c(0.25, 16)) +
  annotate("text", x = 40, y = 6.5, label = label) +
  theme

mcphivfig
```

<br>

###### **Figure 10. Effect of HIV on whether a participant had a concurrent relationship in the previous year, stratified by gender. Odds Ratios (ORs) are from generalized additive models. Models are adjusted for bridgewidth, age (smooth term) and race.** 

<br>

```{r mcpfull_hiv_fig, echo = FALSE}

ticks <- c(0.5, 1.0, 2.0, 4.0)

 label <- c(
   paste0("Pooled OR: ", mcpfullhivmenor, "(", mcpfullhivmenorlwr, "-", mcpfullhivmenorupr, ")"),
   paste0("Pooled OR: ", mcpfullhivwomenor, "(", mcpfullhivwomenorlwr, "-", mcpfullhivwomenorupr, ")")
 )

# Plot all the b's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
mcpfullhivfig <- mcpfullmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("OR") +
  scale_y_log10(breaks = ticks,
                limits = c(0.25, 16)) +
  annotate("text", x = 40, y = 6.5, label = label) +
  theme

mcpfullhivfig
```

<br>

###### **Figure 11. Effect of bridgewidth on whether a participant had a concurrent relationship in the previous year, stratified by gender. Odds Ratios (ORs) are from generalized additive models. Models are adjusted for age (smooth term) and race.** 

<br>

```{r mcp_bw_fig, echo = FALSE}

ticks <- c(0.5, 1.0, 2.0)

 label <- c(
   paste0("Pooled OR: ", mcpbwmenor, "(", mcpbwmenorlwr, "-", mcpbwmenorupr, ")"),
   paste0("Pooled OR: ", mcpbwwomenor, "(", mcpbwwomenorlwr, "-", mcpbwwomenorupr, ")")
 )

# Plot all the b's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
mcpbwfig <- mcpbwmodcoef %>%
  filter(term == "bridgewidth") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("OR") +
  scale_y_log10(breaks = ticks,
                limits = c(0.50, 2)) +
  annotate("text", x = 40, y = 1.5, label = label) +
  theme

mcpbwfig
```

<br>

###### **Figure 12. Effect of bridgewidth on whether a participant had a concurrent relationship in the previous year, stratified by gender. Odds Ratios (ORs) are from generalized additive models. Models are adjusted for hiv, age (smooth term) and race.** 

<br>

```{r mcpfull_bw_fig, echo = FALSE}

ticks <- c(0.5, 1.0, 2.0)

 label <- c(
   paste0("Pooled OR: ", mcpfullbwmenor, "(", mcpfullbwmenorlwr, "-", mcpfullbwmenorupr, ")"),
   paste0("Pooled OR: ", mcpfullbwwomenor, "(", mcpfullbwwomenorlwr, "-", mcpfullbwwomenorupr, ")")
 )

# Plot all the b's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
mcpfullbwfig <- mcpfullmodcoef %>%
  filter(term == "bridgewidth") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("OR") +
  scale_y_log10(breaks = ticks,
                limits = c(0.50, 2)) +
  annotate("text", x = 40, y = 1.5, label = label) +
  theme

mcpfullbwfig
```
<br>

###### **Figure 13. Predicted probabilities of having had a concurrent relationship in the previous year for different values of age (smooth term), by gender. Each line represents a different imputed dataset. These curves represent typical values of race (black) and hiv status (negative)**

<br>

```{r mcp_age_fig, echo = FALSE}

# Spaghetti plot to show each line for dataset by gender
mcpagefig <- mcpmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Probability") +
  theme

mcpagefig

```

<br>

###### **Figure 14. Predicted probabilities of having had a concurrent relationship in the previous year for different values of age (smooth term), by gender. Each line represents a different imputed dataset. These curves represent typical values of race (black) and bridgewidth (3)**

<br>

```{r mcpbw_age_fig, echo = FALSE}

# Plot expected BW's for different values of age
# Spaghetti plot to show each line for dataset by gender
mcpbwagefig <- mcpbwmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Probability") +
  theme

mcpbwagefig

```

<br>

###### **Figure 15. Predicted probabilities of having had a concurrent relationship in the previous year for different values of age (smooth term), by gender. Each line represents a different imputed dataset. These curves represent typical values of race (black), bridgewidth (3) and HIV status (Positive)**

<br>

```{r mcpfull_age_fig, echo = FALSE}

# Plot expected BW's for different values of age
# Spaghetti plot to show each line for dataset by gender
mcpfullagefig <- mcpfullmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Probability") +
  theme

mcpfullagefig

```

<br>

###### **Figure 16. Effect of HIV on "Always" using a condom in relationship, stratified by gender. Odds Ratios (ORs) are from generalized additive mixed models with a random intercept for the participant. Models are adjusted for age and race.**

<br>

```{r cf_hiv_fig, echo = FALSE}
ticks <- c(0.5, 1.0, 2.0, 4.0, 8.0)

cfhivfig <- cfmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  scale_y_log10(breaks = ticks) +
  xlab("Imputation") +
  ylab("OR") +
  theme

cfhivfig

```

<br>

###### **Figure 17. Effect of HIV on "Always" using a condom in relationship, stratified by gender. Odds Ratios (ORs) are from generalized additive mixed models with a random intercept for the participant. Models are adjusted for bridgewidth, age and race.**

<br>

```{r cffull_hiv_fig, echo = FALSE}
ticks <- c(0.5, 1.0, 2.0, 4.0, 8.0)

cffullhivfig <- cffullmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  scale_y_log10(breaks = ticks) +
  xlab("Imputation") +
  ylab("OR") +
  theme

cffullhivfig

```

<br>

###### **Figure 18. Effect of bridgewidth on "Always" using a condom in relationship, stratified by gender. Odds Ratios (ORs) are from generalized additive mixed models with a random intercept for the participant. Models are adjusted for age (smooth term) and race.**

<br>

```{r cf_bw_fig, echo = FALSE}
ticks <- c(0.5, 1.0, 2.0, 4.0, 8.0)

cfbwfig <- cfbwmodcoef %>%
  filter(term == "bridgewidth") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  # scale_y_log10(breaks = ticks) +
  xlab("Imputation") +
  ylab("OR") +
  theme

cfbwfig

```

<br>

###### **Figure 19. Effect of bridgewidth on "Always" using a condom in relationship, stratified by gender. Odds Ratios (ORs) are from generalized additive mixed models with a random intercept for the participant. Models are adjusted for hiv status, age (smooth term) and race.**

<br>

```{r cffull_bw_fig, echo = FALSE}
ticks <- c(0.5, 1.0, 2.0, 4.0, 8.0)

cffullbwfig <- cffullmodcoef %>%
  filter(term == "bridgewidth") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  # scale_y_log10(breaks = ticks) +
  xlab("Imputation") +
  ylab("OR") +
  theme

cffullbwfig

```

<br>

###### **Figure 20. Predicted probabilities of "Always" using a condom in a relationship for different ages of participant, stratified by gender. The predictions are from generalised additive mixed models with a random intercept for the participant. Models are adjusted for hiv status and race.**

<br>

```{r cf_age_fig, echo = FALSE}

cfagefig <- cfmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Probability") +
  theme

cfagefig

```


<br>

###### **Figure 21. Predicted probabilities of "Always" using a condom in a relationship for different ages of participant, stratified by gender. The predictions are from generalised additive mixed models with a random intercept for the participant. Models are adjusted for bridgewidth and race.**

<br>

```{r cfbw_age_fig, echo = FALSE}

cfbwagefig <- cfbwmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Probability") +
  theme

cfbwagefig

```

<br>

###### **Figure 22. Predicted probabilities of "Always" using a condom in a relationship for different ages of participant, stratified by gender. The predictions are from generalised additive mixed models with a random intercept for the participant. Models are adjusted for bridgewidth, hiv status and race.**

<br>

```{r cffull_age_fig, echo = FALSE}

cffullagefig <- cffullmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Probability") +
  theme

cffullagefig

```

<br>

###### **Figure 23. Distribution of average number of times sex occurred per week in relationships, stratified by gender and imputation dataset**

<br>

```{r sf_fig, echo = FALSE}

sffig <- impsexsb %>%
  unnest() %>%
  ggplot(aes(x = relsf, group = .imp)) +
  geom_density() +
  facet_grid(. ~ sex) +
  theme

sffig

```

<br>

###### **Figure 24. Effect of HIV on average number of times sex occurred per week in the relationship, stratified by gender. Incidence Rate Ratios (IRRs) are from generalized additive mixed models (poisson outcome) with a random intercept for the participant. Models are adjusted for age and race.**

<br>

```{r sf_hiv_fig, echo = FALSE}

sfhivfig <- sfmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("IRR") +
  theme

sfhivfig

```

<br>

###### **Figure 25. Effect of HIV on average number of times sex occurred per week in the relationship, stratified by gender. Incidence Rate Ratios (IRRs) are from generalized additive mixed models (poisson outcome) with a random intercept for the participant. Models are adjusted for bridgewidth, age and race.**

<br>

```{r sffull_hiv_fig, echo = FALSE}

sffullhivfig <- sffullmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("IRR") +
  theme

sffullhivfig

```

<br>

###### **Figure 26. Effect of bridgewidth on average number of times sex occurred per week in the relationship, stratified by gender. Incidence Rate Ratios (IRRs) are from generalized additive mixed models (poisson outcome) with a random intercept for the participant. Models are adjusted for age and race.**

<br>

```{r sf_bw_fig, echo = FALSE}

sfbwfig <- sfbwmodcoef %>%
  filter(term == "bridgewidth") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("IRR") +
  theme

sfbwfig

```

<br>

###### **Figure 27. Effect of bridgewidth on average number of times sex occurred per week in the relationship, stratified by gender. Incidence Rate Ratios (IRRs) are from generalized additive mixed models (poisson outcome) with a random intercept for the participant. Models are adjusted for hiv status, age and race.**

<br>

```{r sffull_bw_fig, echo = FALSE}

sffullbwfig <- sffullmodcoef %>%
  filter(term == "bridgewidth") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("IRR") +
  theme

sffullbwfig

```
<br>

###### **Figure 28. Predicted average number of times sex occurred per week in a relationship for different ages of participant, stratified by gender. The predictions are from generalised additive mixed models (poisson outcome) with a random intercept for the participant. Models are adjusted for hiv status and race.**

<br>

```{r sf_age_fig, echo = FALSE}

sfagefig <- sfmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Predicted average number of times sex occurred per week") +
  theme

sfagefig

```

<br>

###### **Figure 29. Predicted average number of times sex occurred per week in a relationship for different ages of participant, stratified by gender. The predictions are from generalised additive mixed models (poisson outcome) with a random intercept for the participant. Models are adjusted for bridgewidth and race.**

<br>

```{r sfbw_age_fig, echo = FALSE}

sfbwagefig <- sfbwmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Predicted average number of times sex occurred per week") +
  theme

sfbwagefig

```

<br>

###### **Figure 30. Predicted average number of times sex occurred per week in a relationship for different ages of participant, stratified by gender. The predictions are from generalised additive mixed models (poisson outcome) with a random intercept for the participant. Models are adjusted for bridgewidth, hiv status, and race.**

<br>

```{r sffull_age_fig, echo = FALSE}

sffullagefig <- sffullmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Predicted average number of times sex occurred per week") +
  theme

sffullagefig

```


```{r close, include = FALSE}
# ====================================================
# Detach libraries and remove objects from environment
# ====================================================
Vectorize(detach)(name = paste0("package:", c("tidyverse", "mice", "gamm4",
                                              "mgcv", "modelr", "broom", "nlme", 
                                              "mediation", "MASS", "magrittr")), 
                  unload = TRUE, 
                  character.only = TRUE)

rm(list=ls())

```

