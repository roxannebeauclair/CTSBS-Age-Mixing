---
title: "CTSBS Age-Mixing"
author: "Roxanne Beauclair"
date: '`r format(Sys.Date(), "%d %b %Y")`'
output: html_document
---

```{r setup, include = FALSE}
# ===================
# Relative file paths
# ===================
wd <- "/Users/roxannebeauclair/Documents/Analytical Projects/PhD/CTSbS Age Mixing/Analysis"
cdata <- paste0(wd, "/Data/Cleaned")

concurdata <- paste0(cdata, "/ctsbs_concur_added_data.rda")
imputedata <- paste0(cdata, "/ctsbs_impute_data.rda")
imputedatapart <- paste0(cdata, "/ctsbs_impute_data_part.rda")
bootdata <- paste0(cdata, "/ctsbs_boot_amp_data.rda")

fxn <- paste0(wd, "/Scripts/00-Functions.R")

# ====================
# Loading dependencies
# ====================
source(fxn)

# magrittr: for use of %>% operator
# tidyverse: for data management functions
# mice: for MI


InstallLoad("magrittr", "MASS", "tidyverse", 
            "mice","nlme", "lme4", "modelr",
            "mgcv", "gamm4", "broom", "splines", 
            "mediation", "forcats", "Gmisc", "htmlTable")

# =============
# Load datasets
# =============
load(imputedata)
load(imputedatapart)
load(concurdata)
load(bootdata)

# ====================
# Set specific global options
# ====================

# Set theme for plots
theme <- theme(axis.title.x = element_text(face = "bold", size = 10),
             axis.text.x  = element_text(angle = 0, face = "bold",
                                         colour = "black", size = 8),
             axis.title.y = element_text(face = "bold", size = 10),
             axis.text.y = element_text(angle = 0, 
                                        face = "bold", 
                                        colour = "black", 
                                        hjust = 0.5,
                                        size = 8),
             plot.title = element_text(lineheight = .8, face = "bold"),
             panel.grid.major = element_line(colour = 'grey82'),
             panel.grid.minor = element_line(colour = NA),
             panel.background = element_rect(fill = 'white'),
             strip.background = element_rect(fill = 'white'),
             strip.text = element_text(size = 8, face = "bold"),
             legend.title = element_text(colour = "black", size = 9, face = "bold"),
             legend.text = element_text(size = 8, face = "bold"),
             plot.margin = unit(c(1.5,1,1,1), "lines"))


# Initialize table counter
options(show.signif.stars = F)
```


```{r df_description, include = FALSE}
# How many exclusions due to sexuality
df1 <- df %>%
  filter(sexorientation != "both" | is.na(sexorientation)) %>%
  filter((sex == "Male" & sexorientation == "Women") |
           ((sex == "Female" & sexorientation == "Men")) |
              (is.na(sex))) 

n_sexuality <- nrow(df) - nrow(df1)

# How many exclusions due to race
df2 <- df1 %>%
  filter(race == "Coloured" | 
           race == "Black" |
           is.na(race)) 

n_race <- nrow(df1) - nrow(df2)

# How many exclusions due to no parter reported
df3 <- df2 %>%
  filter(partner != 0) 

n_nopart <- nrow(df2) - nrow(df3)

# How many relationships left
rels_left <- nrow(df3)

# How many participants left
parts_left <- df3 %>%
  distinct(id) %>%
  nrow()

imp <- max(as.integer(dfimp$.imp)) - 1

# How many relationships started in the last year
df4 <- df3 %>%
  mutate(start = as.factor(ifelse(!is.na(start), "Last year", "before last year"))) %>%
  filter(start == "Last year")

rels_last_year <- nrow(df4)

# How many participants had more than 1 relationship
df5 <- partdfimp %>%
  filter(.imp == 23) %>%
  filter(relcount > 1)

parts_many_partner <- nrow(df5)

rm(df, df1, df2, df3, df4, df5)

```

<br>

**Research questions:** 

1. Describe the age-mixing pattern in the CTSBS population. Does the age-mixing pattern of HIV positive participants differ from HIV negative participants?
2. At the individual-level are large ranges in partner ages (bridgewidths) associated with HIV status of a participant?

Before conducting imputations, I excluded participants who said their sexual preferences were for "both" genders or the same gender (n = `r n_sexuality`). I further excluded people who did not identify as black or coloured (n = `r n_race`) and people who did not report partners in the previous year (n = `r n_nopart`). Participants who had missing observations on those characteristics were left in the dataset. This left `r rels_left` relationships reported by `r parts_left` participants. Of the `r parts_left` participants, `r parts_many_partner` reported more than one relationship in the previous year. I imputed `r imp` datasets using the random forest method for continuous and nominal categorical variables and the "polr" method for our ordinal variables. 

### **AGE-MIXING PATTERN**


```{r slope_int_setup, include = FALSE, warning = FALSE}
# Unnest tidy summary for data on slope and intercept
# of all the models
modslopeint <- tidysumamp %>%
  unnest(modelsum, .drop = TRUE)

modslopeint

# Create df where the terms are in wide format according
# to subgroup, so that we can calculate differences
slopeintdif <- modslopeint %>%
  select(-std.error, -statistic, -p.value) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, estimate) 

slopeintdif

# Calculate differences in slopes for:
# 1. Males vs. Females in neg population
# 2. Males vs. Females in pos population
# 3. Pos vs Neg in male population
# 4. Pos vs Neg in female population

difslopesum <- slopeintdif %>%
  filter(term == "age0") %>%
  mutate(gendifneg = Female_Negative - Male_Negative, # Ha: Female slopes larger than males
         gendifpos = Female_Positive - Male_Positive, # Ha; Female slopes larger than males
         hivdifmale = Male_Negative - Male_Positive, # Ha: Negative slopes larger than pos
         hivdiffemale = Female_Negative - Female_Positive) # Ha: Neg slopes larger than pos

difslopesum

# Calculate differences in intercepts for:
# 1. Males vs. Females in neg population
# 2. Males vs. Females in pos population
# 3. Pos vs Neg in male population
# 4. Pos vs Neg in female population

difintsum <- slopeintdif %>%
  filter(term == "(Intercept)") %>%
  mutate(gendifneg = Female_Negative - Male_Negative, # Ha: Female intercepts larger than males
         gendifpos = Female_Positive - Male_Positive, # Ha; Female intercepts larger than males
         hivdifmale = Male_Positive - Male_Negative, # Ha: Pos intercepts larger than neg
         hivdiffemale = Female_Positive - Female_Negative) # Ha: Pos intercepts larger than neg

difintsum

# Now take all of the estimates and calculate CI's using percentile method
alpha = 0.05

slopeintci <- modslopeint %>%
  group_by(term, sex, hiv) %>%
  summarise(mean = mean(estimate),
            lwr = quantile(estimate, alpha / 2),
            upr = quantile(estimate, 1- alpha / 2))

slopeintci

slopedifci <- difslopesum %>%
  summarise(meangendifneg = mean(gendifneg),
            meangendifpos = mean(gendifpos),
            meanhivdifmale = mean(hivdifmale),
            meanhivdiffemale = mean(hivdiffemale),
            lwrgendifneg = quantile(gendifneg, alpha / 2),
            lwrgendifpos = quantile(gendifpos, alpha / 2),
            lwrhivdifmale = quantile(hivdifmale, alpha / 2),
            lwrhivdiffemale = quantile(hivdiffemale, alpha / 2),
            uprgendifneg = quantile(gendifneg, 1 - alpha / 2),
            uprgendifpos = quantile(gendifpos, 1 - alpha / 2),
            uprhivdifmale = quantile(hivdifmale, 1 - alpha / 2),
            uprhivdiffemale = quantile(hivdiffemale, 1 - alpha / 2)) %>%
  mutate_all(funs(round(., 2)))

intdifci <- difintsum %>%
  summarise(meangendifneg = mean(gendifneg),
            meangendifpos = mean(gendifpos),
            meanhivdifmale = mean(hivdifmale),
            meanhivdiffemale = mean(hivdiffemale),
            lwrgendifneg = quantile(gendifneg, alpha / 2),
            lwrgendifpos = quantile(gendifpos, alpha / 2),
            lwrhivdifmale = quantile(hivdifmale, alpha / 2),
            lwrhivdiffemale = quantile(hivdiffemale, alpha / 2),
            uprgendifneg = quantile(gendifneg, 1 - alpha / 2),
            uprgendifpos = quantile(gendifpos, 1 - alpha / 2),
            uprhivdifmale = quantile(hivdifmale, 1 - alpha / 2),
            uprhivdiffemale = quantile(hivdiffemale, 1 - alpha / 2)) %>%
  mutate_all(funs(round(., 2)))

```

```{r wvar_setup, include = FALSE, warning = FALSE}

# Unnest tidy summary for data on within individual variance
modwvar <- tidysumamp %>%
  unnest(wvar, .drop = TRUE)

modwvar

wvardif <- modwvar %>%
  select(-lwrwsd, -uprwsd) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, wsd) 

wvardif

# Calculate differences in within-subject sd for:
# 1. Males vs. Females in neg population
# 2. Males vs. Females in pos population
# 3. Pos vs Neg in male population
# 4. Pos vs Neg in female population

difwvarsum <- wvardif %>%
  mutate(gendifneg = Female_Negative - Male_Negative, # Ha: Female wvar larger than males
         gendifpos = Female_Positive - Male_Positive, # Ha; Female wvar larger than males
         hivdifmale = Male_Positive - Male_Negative, # Ha: Pos wvar larger than neg
         hivdiffemale = Female_Positive - Female_Negative) # Ha: Pos wvar larger than neg

difwvarsum

# Now take all of the wvars and calculate CI's using percentile method
alpha = 0.05

wsdci <- modwvar %>%
  group_by(sex, hiv) %>%
  summarise(mean = mean(wsd),
            lwr = quantile(wsd, alpha / 2),
            upr = quantile(wsd, 1- alpha / 2))

wsdci

wvardifci <- difwvarsum %>%
  summarise(meangendifneg = mean(gendifneg),
            meangendifpos = mean(gendifpos),
            meanhivdifmale = mean(hivdifmale),
            meanhivdiffemale = mean(hivdiffemale),
            lwrgendifneg = quantile(gendifneg, alpha / 2),
            lwrgendifpos = quantile(gendifpos, alpha / 2),
            lwrhivdifmale = quantile(hivdifmale, alpha / 2),
            lwrhivdiffemale = quantile(hivdiffemale, alpha / 2),
            uprgendifneg = quantile(gendifneg, 1 - alpha / 2),
            uprgendifpos = quantile(gendifpos, 1 - alpha / 2),
            uprhivdifmale = quantile(hivdifmale, 1 - alpha / 2),
            uprhivdiffemale = quantile(hivdiffemale, 1 - alpha / 2)) %>%
  mutate_all(funs(round(., 2)))


```

```{r bvar_setup, include = FALSE, warning = FALSE}

# Unnest tidy summary for data on between individual variance
modbvar <- tidysumamp %>%
  unnest(bvar, .drop = TRUE)

modbvar

bvardif <- modbvar %>%
  select(-lwrbsd, -uprbsd) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, bsd) 

bvardif

# Calculate differences in between-subject sd for:
# 1. Males vs. Females in neg population
# 2. Males vs. Females in pos population
# 3. Pos vs Neg in male population
# 4. Pos vs Neg in female population

difbvarsum <- bvardif %>%
  mutate(gendifneg = Male_Negative - Female_Negative, # Ha: Male bvar larger than females
         gendifpos = Male_Positive - Female_Positive, # Ha; Male bvar larger than females
         hivdifmale = Male_Negative - Male_Positive, # Ha: Neg bvar larger than pos
         hivdiffemale = Female_Negative - Female_Positive) # Ha: Neg bvar larger than pos

difbvarsum

# Now take all of the bvars and calculate CI's using percentile method
alpha = 0.05

bsdci <- modbvar %>%
  group_by(sex, hiv) %>%
  summarise(mean = mean(bsd),
            lwr = quantile(bsd, alpha / 2),
            upr = quantile(bsd, 1- alpha / 2))

bsdci

bvardifci <- difbvarsum %>%
  summarise(meangendifneg = mean(gendifneg),
            meangendifpos = mean(gendifpos),
            meanhivdifmale = mean(hivdifmale),
            meanhivdiffemale = mean(hivdiffemale),
            lwrgendifneg = quantile(gendifneg, alpha / 2),
            lwrgendifpos = quantile(gendifpos, alpha / 2),
            lwrhivdifmale = quantile(hivdifmale, alpha / 2),
            lwrhivdiffemale = quantile(hivdiffemale, alpha / 2),
            uprgendifneg = quantile(gendifneg, 1 - alpha / 2),
            uprgendifpos = quantile(gendifpos, 1 - alpha / 2),
            uprhivdifmale = quantile(hivdifmale, 1 - alpha / 2),
            uprhivdiffemale = quantile(hivdiffemale, 1 - alpha / 2)) %>%
  mutate_all(funs(round(., 2)))
```

```{r power_setup, include = FALSE, warning = FALSE}

# Unnest tidy summary for (lme) data on power coefficient
modpower <- tidysumamp %>%
  unnest(power, .drop = TRUE)

modpower

powerdif <- modpower %>%
  select(-lwrpow, -uprpow) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, power) 

powerdif

# Calculate differences in power coefficient for:
# 1. Males vs. Females in neg population
# 2. Pos vs Neg in male population


difpowersum <- powerdif %>%
  mutate(gendifneg = Male_Negative - Female_Negative, # Ha: Male power larger than females
         hivdifmale = Male_Negative - Male_Positive) # Ha: Neg power larger than pos

difpowersum

# Now take all of the power coefficients and calculate CI's 
# using percentile method
alpha = 0.05

powerci <- modpower %>%
  filter(sex == "Male" |
           hiv == "Negative") %>%
  group_by(sex, hiv) %>%
  summarise(mean = mean(power, na.rm = T),
            lwr = quantile(power, alpha / 2, na.rm = T),
            upr = quantile(power, 1- alpha / 2, na.rm = T))

powerci

powerdifci <- difpowersum %>%
  summarise(meangendifneg = mean(gendifneg, na.rm = T),
            meanhivdifmale = mean(hivdifmale, na.rm = T),
            lwrgendifneg = quantile(gendifneg, alpha / 2, na.rm = T),
            lwrhivdifmale = quantile(hivdifmale, alpha / 2, na.rm = T),
            uprgendifneg = quantile(gendifneg, 1 - alpha / 2, na.rm = T),
            uprhivdifmale = quantile(hivdifmale, 1 - alpha / 2, na.rm = T)) %>%
  mutate_all(funs(round(., 2)))

```

<br>


```{r amp_model_slope_plot, echo = FALSE, warning = FALSE, fig.height = 8}

# Plot all of the beta's for age mixing pattern in 
# each of the datasets (by imputation and gender)
means <- slopeintci %>%
  filter(term == "age0")

slopeplot <- modslopeint %>%
  filter(term == "age0") %>%
  ggplot(aes(x = estimate)) +
  geom_density(alpha = 0.2, fill = "blue") +
  geom_vline(aes(xintercept = mean), 
             data = means,
             linetype = "dashed") +
  geom_vline(aes(xintercept = lwr), 
             data = means,
             linetype = "dashed") +
  geom_vline(aes(xintercept = upr), 
             data = means,
             linetype = "dashed") +
  facet_grid(hiv ~ sex) +
  xlab("Slope of regression line") +
  theme

slopeplot
```

###### **Figure 2. Distribution of age-mixing model slopes for 50 imputed datasets, each bootstraped 10 times.**

<br>

The average difference between: 

* Male and female slopes in the HIV negative population was `r slopedifci$meangendifneg` (95% CI: `r slopedifci$lwrgendifneg` - `r slopedifci$uprgendifneg`)
* Male and female slopes in the HIV positive population was `r slopedifci$meangendifpos` (95% CI: `r slopedifci$lwrgendifpos` - `r slopedifci$uprgendifpos`)
* HIV positive and negative slopes in the male population was `r slopedifci$meanhivdifmale` (95% CI: `r slopedifci$lwrhivdifmale` - `r slopedifci$uprhivdifmale`)
* HIV positive and negative slopes in the female population was `r slopedifci$meanhivdiffemale` (95% CI: `r slopedifci$lwrhivdiffemale` - `r slopedifci$uprhivdiffemale`)


<br>


```{r amp_model_intercept_plot, echo = FALSE, warning = FALSE, fig.height = 8}

# Plot all of the intercepts for age mixing pattern in 
# each of the  datasets (by imputation and gender)
means <- slopeintci %>%
  filter(term == "(Intercept)")

interplot <- modslopeint %>%
  filter(term == "(Intercept)") %>%
  ggplot(aes(x = estimate)) +
  geom_density(alpha = 0.2, fill = "blue") +
  geom_vline(aes(xintercept = mean), 
             data = means,
             linetype = "dashed") +
  geom_vline(aes(xintercept = lwr), 
             data = means,
             linetype = "dashed") +
  geom_vline(aes(xintercept = upr), 
             data = means,
             linetype = "dashed") +
  facet_grid(hiv ~ sex) +
  xlab("Partner age for 15 year olds") +
  theme

interplot
```

###### **Figure 3. Distribution of age-mixing model intercepts for 50 imputed datasets, each bootstraped 10 times.**

<br>

The average difference between: 

* Male and female intercepts in the HIV negative population was `r intdifci$meangendifneg` (95% CI: `r intdifci$lwrgendifneg` - `r intdifci$uprgendifneg`)
* Male and female intercepts in the HIV positive population was `r intdifci$meangendifpos` (95% CI: `r intdifci$lwrgendifpos` - `r intdifci$uprgendifpos`)
* HIV positive and negative intercepts in the male population was `r intdifci$meanhivdifmale` (95% CI: `r intdifci$lwrhivdifmale` - `r intdifci$uprhivdifmale`)
* HIV positive and negative intercepts in the female population was `r intdifci$meanhivdiffemale` (95% CI: `r intdifci$lwrhivdiffemale` - `r intdifci$uprhivdiffemale`)

<br>

```{r amp_model_wvar_plot, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot each of the residual variances for age mixing pattern
# in each of the datasets (by imputation and gender)
wvarplot <- modwvar %>%
  ggplot(aes(x = wsd)) +
  geom_density(alpha = 0.2, fill = "blue") +
  geom_vline(aes(xintercept = mean), 
             data = wsdci,
             linetype = "dashed") +
  geom_vline(aes(xintercept = lwr), 
             data = wsdci,
             linetype = "dashed") +
  geom_vline(aes(xintercept = upr), 
             data = wsdci,
             linetype = "dashed") +
  scale_x_continuous(limits = c(0, 65)) +
  facet_grid(hiv ~ sex) +
  xlab("Within-subject Standard Deviation") +
  theme

wvarplot
```

###### **Figure 4. Distribution of age-mixing within-subject standard deviations (wsd) for 50 imputed datasets, each bootstraped 10 times.**

<br>

The average difference between: 

* Male and female wsd in the HIV negative population was `r wvardifci$meangendifneg` (95% CI: `r wvardifci$lwrgendifneg` - `r wvardifci$uprgendifneg`)
* Male and female wsd in the HIV positive population was `r wvardifci$meangendifpos` (95% CI: `r wvardifci$lwrgendifpos` - `r wvardifci$uprgendifpos`)
* HIV positive and negative wsd in the male population was `r wvardifci$meanhivdifmale` (95% CI: `r wvardifci$lwrhivdifmale` - `r wvardifci$uprhivdifmale`)
* HIV positive and negative wsd in the female population was `r wvardifci$meanhivdiffemale` (95% CI: `r wvardifci$lwrhivdiffemale` - `r wvardifci$uprhivdiffemale`)

<br>


```{r amp_model_bvar_plot, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot each of the between subject variances for age mixing pattern
# in each of the datasets (by imputation and gender)
bvarplot <- modbvar %>%
  ggplot(aes(x = bsd)) +
  geom_density(alpha = 0.2, fill = "blue") +
  geom_vline(aes(xintercept = mean), 
             data = bsdci,
             linetype = "dashed") +
  geom_vline(aes(xintercept = lwr), 
             data = bsdci,
             linetype = "dashed") +
  geom_vline(aes(xintercept = upr), 
             data = bsdci,
             linetype = "dashed") +
  facet_grid(hiv ~ sex) +
  xlab("Between-subject Standard Deviation") +
  theme

bvarplot
```

###### **Figure 5. Distribution of age-mixing between-subject standard deviations (bsd) for 50 imputed datasets, each bootstraped 10 times.**

<br>

The average difference between: 

* Male and female bsd in the HIV negative population was `r bvardifci$meangendifneg` (95% CI: `r bvardifci$lwrgendifneg` - `r bvardifci$uprgendifneg`)
* Male and female bsd in the HIV positive population was `r bvardifci$meangendifpos` (95% CI: `r bvardifci$lwrgendifpos` - `r bvardifci$uprgendifpos`)
* HIV positive and negative bsd in the male population was `r bvardifci$meanhivdifmale` (95% CI: `r bvardifci$lwrhivdifmale` - `r bvardifci$uprhivdifmale`)
* HIV positive and negative bsd in the female population was `r bvardifci$meanhivdiffemale` (95% CI: `r bvardifci$lwrhivdiffemale` - `r bvardifci$uprhivdiffemale`)

<br>

```{r amp_model_power_plot, echo = FALSE, warning = FALSE, fig.height = 8}

# The formula to calculate the weights for variance is |v|^(2*t)
# I belive t is the power coefficient

powplot <- modpower %>%
  ggplot(aes(x = power)) +
  geom_density(alpha = 0.2, fill = "blue") +
  geom_vline(aes(xintercept = mean), 
             data = powerci,
             linetype = "dashed") +
  geom_vline(aes(xintercept = lwr), 
             data = powerci,
             linetype = "dashed") +
  geom_vline(aes(xintercept = upr), 
             data = powerci,
             linetype = "dashed") +
  facet_grid(hiv ~ sex) +
  xlab("Power coefficient") +
  theme

powplot
```

###### **Figure 6. Distribution for power coefficients for 50 imputed datasets, each bootstraped 10 times.**

<br>

The average difference between: 
 
* Male and female power coefficient in the HIV negative population was `r powerdifci$meangendifneg` (95% CI: `r powerdifci$lwrgendifneg` - `r powerdifci$uprgendifneg`)
 
* HIV positive and negative power coefficient in the male population was `r powerdifci$meanhivdifmale` (95% CI: `r powerdifci$lwrhivdifmale` - `r powerdifci$uprhivdifmale`)

```{r hiv_prev, echo = FALSE, warning = FALSE}
hivprev <- partdfimp %>%
  filter(.imp == n) %>%
  mutate(agegroup = cut(age,
                        breaks = c(0, 24, 29, 34, 
                                   39, 44, 49, 54, 59,
                                   70),
                        labels = c("15-24", "25-29", 
                                   "30-34", "35-39", "40-44", 
                                   "45-49", "50-54", "55-59", 
                                   "60+"))) %>%
  group_by(sex, agegroup, hiv) %>%
  summarise(n = n()) %>%
  mutate(total = sum(n),
         prop = n / total) %>%
  ungroup() %>%
  group_by(sex, agegroup, hiv, n, total) %>%          # The binom.test() function is not vectorized,
  mutate(ll = binom.test(n, total)$conf.int[1],       # and thus, we need to make sure each row is   
         ul = binom.test(n, total)$conf.int[2])       # treated as an individual data frame

hivprevplot <- hivprev %>%
  filter(hiv == "Positive") %>%
  ggplot(aes(x = agegroup, y = prop, fill = sex)) +
  geom_bar(stat = "identity",
           position = position_dodge()) +
  geom_errorbar(aes(ymax = ul, ymin = ll),
                position = position_dodge(0.9),
                width = 0.10) +
  xlab("Age group") +
  ylab("Proportion") +
  scale_fill_hue(name = "Gender") +
  theme

hivprevplot
  

```


###### **Figure 7. HIV prevalence by sex and age in randomly selected imputed dataset**

<br>

```{r age_hiv_fig, include = FALSE, warning = FALSE, fig.height = 8}
# Create dataframe that summarizes the proportion of relationships
# in different partner age groups for people who are HIV
# positive
hivbyage <- dfimp %>%
  filter(.imp == n & hiv == "Positive") %>%
  group_by(sex, agepgroup) %>%
  summarise(n = n()) %>%
  mutate(prop = round((n / sum(n)) * 100, 2))

# barplot of fraction of relationships in different partner age groups  
hivageplot <- hivbyage %>%
  ggplot(aes(x = agepgroup, y = prop, fill = sex)) +
  geom_bar(stat = "identity",
           position = position_dodge()) +
  xlab("Age group of partner") +
  ylab("Proportion of relationships") +
  scale_fill_brewer(palette = "Dark2") +
  theme

hivageplot
  
```

<br>

### **REPORTING MORE THAN ONE PARTNER**

<br>

```{r multiple partners_setup, include = FALSE, warning = FALSE}
dfmpm <- partdfimp %>% 
  filter(.imp == n & 
           sex == "Male") %>%
  mutate(mp = as.factor(ifelse(relcount > 1, "Multiple", "One"))) 

dfmpw <- partdfimp %>%
  filter(.imp == n & 
           sex == "Female") %>%
  mutate(mp = as.factor(ifelse(relcount > 1, "Multiple", "One"))) 

agem <- GetT1Stat(dfmpm$agegroup, dfmpm$mp)
agew <- GetT1Stat(dfmpw$agegroup, dfmpw$mp)

hivm <- GetT1Stat(dfmpm$hiv, dfmpm$mp)
hivw <- GetT1Stat(dfmpw$hiv, dfmpw$mp)


tab1 <- list()

tab1[["Age"]] <- cbind(agew, agem)
tab1[["HIV status"]] <- cbind(hivm, hivw)
```

```{r multiple_partners_table, echo = FALSE, warning = FALSE}
mergeDesc(tab1) %>%
  htmlTable(caption = "<b>Table 1. Proportion of participants reporting more than 1 partner<b/>",
            tfoot = "Categories are reported in percentages, n (%).",
            cgroup = c("Women", "Men"), 
            n.cgroup = c(2, 2), 
            ctable = TRUE,
            padding.rgroup = "&nbsp; &nbsp; &nbsp;")

```

<br>

### **DO BRIDGEWIDTHS GROW WITH AGE?**

```{r bw_age_sd_setup, include = FALSE}
bwdfm <- partdfimp %>%
  filter(.imp == n) %>%
  filter(sex == "Male" &
           relcount > 1) %>%
  select(agegroup, bridgewidth) %>%
  group_by(agegroup) %>%
  summarise(n = n(),
            Median = median(bridgewidth),
            Q25 = summary(bridgewidth)[[2]],
            Q75 = summary(bridgewidth)[[5]]) %>%
  data.frame(row.names = 1) %>%
  format(nsmall = 1)
  

bwdfw <- partdfimp %>%
  filter(.imp == n) %>%
  filter(sex == "Female" &
           relcount > 1) %>%
  select(agegroup, bridgewidth) %>%
  group_by(agegroup) %>%
  summarise(n = n(),
            Median = median(bridgewidth),
            Q25 = summary(bridgewidth)[[2]],
            Q75 = summary(bridgewidth)[[5]]) %>%
  data.frame(row.names = 1) %>%
  format(nsmall = 1)
  
```

```{r bw_age_sd_table, echo = FALSE}

htmlTable(cbind(bwdfm, bwdfw),
          caption = "<b>Table 2. Median and IQR for bridgewidth by age and gender in randomly selected imputed dataset<b/>",
          ctable = TRUE,
          tfoot = txtMergeLines("IQR, Inter-quartile range",
                                "Q25, Lower quartile",
                                "Q75, Upper quartile"),
          cgroup = c("Male", "Female"),
          n.cgroup = c(4,4),
          rowlabel = "Age category")

```


<br>

### **DOES HIV STATUS PREDICT BRIDGEWIDTH?**

<br>

Here I used generalised additive models with negative binomial regression to regress bridgewidths on HIV status of the participant before enterring our study. In these models, the participant is the unit of observation and only participants reporting more than one partner in the previous year were included. Separate models were created for men and women, as well as imputed datasets. The models adjust for age(smooth term) and race. 

<br>

```{r bw_hiv_setup, include = FALSE, warning = FALSE}
# Exclude complete cases dataframe
# Keep only participants with more than one relationship in the past year
impsex <- partdfimp %>% 
  filter(.imp != 0) %>%
  group_by(.imp, sex) 

# Summarize the median and IQR of bW by sex and dataset
# Among those with more than 1 partner
bwbyimpsex <- impsex %>%
  filter(relcount > 1) %>%
  summarise(n = n(),
            Median = median(bridgewidth),
            Mean = mean(bridgewidth),
            sd = sd(bridgewidth),
            lwr = summary(bridgewidth)[[2]],
            upr = summary(bridgewidth)[[5]])

# Nest all the datasets by sex and imputation
impsexbw <- impsex %>% 
  filter(relcount > 1) %>%
  nest()

# Does HIV predict bridgewidths (neg bin models)?
# Does HIV predict whether a participant had a concurrent rel in past year (logistic models)?

tidysum <- impsexbw %>% # A model will be applied to all imputations and sex
  mutate(modelbw = map(data, bwmodel),
         modelsumbw = map(modelbw, tidygam), # Create tidy summary of each model and store as modelsum var in nested df
         predsbwage = map(modelbw, gampredsage)) # Create predictions across dif vals of age (our spline var))

# Unnest the tidy summary, to see the tidy model estimates for each model
bwmodcoef <- tidysum %>%
  unnest(modelsumbw, .drop = TRUE) 

# Unnest the tidy summary, to see the tidy model predictions for values of age
# for each model
bwmodpredage <- tidysum %>%
  unnest(predsbwage, .drop = TRUE)

```



```{r pool_bw_coef, include = FALSE, warning = FALSE}

# Now we want to produce a pooled beta for HIV according to 
# Rubin's rules. To do this we use mice functions

part <- partdfimp %>% # Take original participant-level imputed df
   filter(relcount > 1) %>% # Only participants who had more than one rel
   as.mids() # Create mids object
 
bwmodpoolm <- part %>%
   with(
     gam(bridgewidth ~ hiv + s(age) + race,
         family = nb(),
         subset = (sex == "Male"))
     ) %>%
   pool() %>% # Pool coefficients according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
bwmodpoolw <- part %>%
   with(
     gam(bridgewidth ~ hiv + s(age) + race,
         family = nb(),
         subset = (sex == "Female"))
     ) %>%
   pool() %>% # Pool according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
 menEBWR <- bwmodpoolm[2, 1] # Extract HIV EBWR 
 menEBWRlwr <- bwmodpoolm[2, 6] # Extract HIV lower CI limit
 menEBWRupr <- bwmodpoolm[2, 7] # Extract HIV upper CI limit
 womenEBWR <- bwmodpoolw[2, 1]
 womenEBWRlwr <- bwmodpoolw[2, 6]
 womenEBWRupr <- bwmodpoolw[2, 7]
 
 
```


```{r bw_dist_figs_setup, include = FALSE, warning = FALSE}
bwdf <- partdfimp %>% 
  filter(.imp != 0 &
           relcount > 1) 
```


<br>



```{r bw_hiv_density_fig, echo = FALSE, warning = FALSE}

# Check spread of bridgwidths for each grouped dataset
bwhivfig <- bwdf %>%
  ggplot(aes(x = bridgewidth, group = .imp)) +
  geom_density(adjust = 2) +
  facet_grid(hiv ~ sex) +
  xlab("bridgewidth") +
  ylab("Density") +
  theme

bwhivfig
```

###### **Figure 8. Distribution of bridge widths for each imputed dataset, by sex and HIV status.**

<br>


```{r bw_age_density_fig, echo = FALSE, warning = FALSE}

# Check spread of bridgwidths for each grouped dataset
bwagefig <- bwdf %>%
  ggplot(aes(x = bridgewidth, group = .imp)) +
  geom_density(adjust = 2) +
  facet_grid(agegroup ~ sex) +
  xlab("bridgewidth") +
  ylab("Density") +
  theme

bwagefig
```

###### **Figure 9. Distribution of bridge widths for each imputed dataset, by sex and agegroup.**

<br>


```{r bw_hiv_fig, echo = FALSE, warning = FALSE}

ticks <- c(0.5, 1.0, 2.0, 4.0)

 label <- c(
   paste0("Pooled EBWR: ", menEBWR, "(", menEBWRlwr, "-", menEBWRupr, ")"),
   paste0("Pooled EBWR: ", womenEBWR, "(", womenEBWRlwr, "-", womenEBWRupr, ")")
 )

# Plot all the b's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
bwhivfig <- bwmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("Expected Bridge Width Ratio") +
  scale_y_log10(breaks = ticks) +
   annotate("text", x = 40, y = 6.5, label = label) +
  theme

bwhivfig
```


###### **Figure 10. Model coefficients for relationship between HIV and bridgewidth.**

<br>


```{r bw_age_fig, echo = FALSE, warning = FALSE}

# Plot expected BW's for different values of age (or spline variable)
# Spaghetti plot to show each line for dataset by gender
bwagefig <- bwmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line(aes(alpha = 0.05)) +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Expected Bridge Width") +
  guides(alpha = "none") +
  theme

bwagefig

```

###### **Figure 11. Expected bridge widths for different values of age (smooth term), by gender.**

<br>

```{r close, include = FALSE, warning = FALSE}
# ====================================================
# Detach libraries and remove objects from environment
# ====================================================
Vectorize(detach)(name = paste0("package:", c("tidyverse", "mice", "gamm4",
                                              "mgcv", "modelr", "broom", "nlme", 
                                              "mediation", "MASS", "magrittr")), 
                  unload = TRUE, 
                  character.only = TRUE)

rm(list=ls())

```

