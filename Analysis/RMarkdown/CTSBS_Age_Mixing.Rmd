---
title: "CTSBS Age-Mixing"
author: "Roxanne Beauclair"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output: html_document
---

```{r setup, include = FALSE}
# ===================
# Relative file paths
# ===================
wd <- "/Users/roxannebeauclair/Documents/Analytical Projects/PhD/CTSBS Age Mixing/Analysis"
cdata <- paste0(wd, "/Data/Cleaned")

concurdata <- paste0(cdata, "/ctsbs_concur_added_data.rda")
imputedata <- paste0(cdata, "/ctsbs_impute_data.rda")
imputedatapart <- paste0(cdata, "/ctsbs_impute_data_part.rda")

fxn <- paste0(wd, "/Scripts/00-Functions.R")

# ====================
# Loading dependencies
# ====================
source(fxn)

# magrittr: for use of %>% operator
# tidyverse: for data management functions
# mice: for MI


InstallLoad("magrittr", "MASS", "tidyverse", 
            "mice","nlme", "modelr",
            "mgcv", "broom")

# =============
# Load datasets
# =============
load(imputedata)
load(imputedatapart)
load(concurdata)

# ====================
# Set specific global options
# ====================

# Set theme for plots
theme <- theme(axis.title.x = element_text(face = "bold", size = 10),
             axis.text.x  = element_text(angle = 0, face = "bold",
                                         colour = "black", size = 8),
             axis.title.y = element_text(face = "bold", size = 10),
             axis.text.y = element_text(angle = 0, 
                                        face = "bold", 
                                        colour = "black", 
                                        hjust = 0.5,
                                        size = 8),
             plot.title = element_text(lineheight = .8, face = "bold"),
             panel.grid.major = element_line(colour = 'grey82'),
             panel.grid.minor = element_line(colour = NA),
             panel.background = element_rect(fill = 'white'),
             strip.background = element_rect(fill = 'white'),
             strip.text = element_text(size = 8, face = "bold"),
             legend.title = element_text(colour = "black", size = 9, face = "bold"),
             legend.text = element_text(size = 8, face = "bold"),
             plot.margin = unit(c(1.5,1,1,1), "lines"))


# Initialize table counter
options(show.signif.stars = F)
```


```{r df_description, include = FALSE}
# How many exclusions due to sexuality
df1 <- df %>%
  filter(sexorientation != "Both" | is.na(sexorientation)) %>%
  filter((sex == "Male" & sexorientation == "Women") |
           ((sex == "Female" & sexorientation == "Men")) |
              (is.na(sex))) 

n_sexuality <- nrow(df) - nrow(df1)

# How many exclusions due to race
df2 <- df1 %>%
  filter(race == "Coloured" | 
           race == "Black" |
           is.na(race)) 

n_race <- nrow(df1) - nrow(df2)

# How many exclusions due to no parter reported
df3 <- df2 %>%
  filter(partner != 0) 

n_nopart <- nrow(df2) - nrow(df3)

# How many relationships left
rels_left <- nrow(df3)

# How many participants left
parts_left <- df3 %>%
  distinct(id) %>%
  nrow()

imp <- max(as.integer(dfimp$.imp)) - 1

# How many relationships started in the last year
df4 <- df3 %>%
  mutate(start = as.factor(ifelse(!is.na(start), "Last year", "Before last year"))) %>%
  filter(start == "Last year")

rels_last_year <- nrow(df4)

rm(df, df1, df2, df3, df4)

```

<br>

Before conducting imputations, I excluded participants who said their sexual preferences were for "both" genders or the same gender (n = `r n_sexuality`). I further excluded people who did not identify as black or coloured (n = `r n_race`) and people who did not report partners in the previous year (n = `r n_nopart`). Missing observations on those characteristics were left in the dataset. This left `r rels_left` relationships reported by `r parts_left` participants. Of those relationships `r rels_last_year` started in the 12 months preceeding the survey. I imputed `r imp` datasets using the random forest method for continuous and nominal categorical variables and the "polr" method for our ordinal variables. 

```{r amp_setup, include = FALSE}

# What is the age mixing pattern?
set.seed(47621)
n <- sample(1:imp, 1)

# Smaller datasets
dfamp <- dfimp %>%
  filter(.imp == n) %>%
  select(id, age, agemean, age2sd, agep, sex,
         missage, missagep, hiv) 

dfampm <- dfamp %>%
  filter(sex == "Male")

dfampw <- dfamp %>%
  filter(sex == "Female")


# Now fit separate models for men and women
ampmodm1 <- lme(agep ~ agemean, 
           data = dfampm, 
           random = ~1 | id,  
           method = "REML")

ampmodw1 <- lme(agep ~ agemean, 
           data = dfampw, 
           random = ~1 | id,
           method = "REML")

ampmodm2 <- gamm(agep ~ s(agemean), 
           data = dfampm, 
           random = list(id = ~1))

ampmodw2 <- gamm(agep ~ s(agemean), 
           data = dfampw, 
           random = list(id = ~1))


# Add the predicted values and residuals to the dataset
dfampm <- dfampm %>%
  mutate(pred.1 = predict(ampmodm1, newdata = ., level = 0),
         pred.2 = predict(ampmodm2$gam, newdata = .),
         resid.2 = residuals(ampmodm2$gam)) %>%
  add_residuals(ampmodm1, var = "resid.1")

dfampw <- dfampw %>%
  mutate(pred.1 = predict(ampmodw1, newdata = ., level = 0),
         pred.2 = predict(ampmodw2$gam, newdata = .),
         resid.2 = residuals(ampmodw2$gam))%>%
  add_residuals(ampmodw1, var = "resid.1") 

#Combine both datasets again
comb <- bind_rows(dfampm, dfampw) %>%
  gather(key, value, -id:-hiv) %>%
  separate(key, into = c("type", "model"), sep = "\\.")
  
```

<br>

###### **Figure 1. Age mixing pattern for randomly selected imputed dataset. Model 1 represents the linear mixed effects model with age as a linear term. Model 2 represents the GAMM with age as a smoothed term**

<br>

```{r amp_fig, echo = FALSE}
# Figure visualizing the age mixing pattern
ampfig <- comb %>%
  filter(type == "pred") %>%
  ggplot(aes(x = age, y = value)) +
  geom_point(aes(x = age, 
                 y = agep, 
                 color = missagep), 
             position = position_jitter(width = 0.75, height = 0.75),
             size = 1) +
  geom_abline(size = 1, 
              aes(intercept = 0, slope = 1, linetype = "Same age"), 
              show.legend = FALSE) +
  geom_line(aes(linetype = "Population mean"), 
            size = 1) +
  facet_grid(model ~ sex) + 
  scale_y_continuous(name = "Partner's ages") +
  scale_color_manual('Imputation Status', values = c('grey70', 'grey42')) +
  scale_linetype_manual('Lines', values = c("Population mean" = 1, 'Same age' = 2)) +
  xlab("Participant's age (centered on mean age)") +
  guides(linetype = guide_legend(keywidth = 2, keyheight = 1)) +
  theme

ampfig

```

<br>

###### **Figure 2. 2A visualizes the spread of the residuals for the different models. Model 1 is the linear mixed effect model with age as a linear term, while Model 2 is a GAMM. 2B visualizes the pattern of residuals for the lme and gamm. In both models there appears to be constant variance**

<br>

```{r amp_res_fig, echo = FALSE}
# Visualizing spread of residuals for lm and gam model
ampresfig1 <- comb %>%
  filter(type == "resid") %>%
  ggplot(aes(value)) +
  geom_freqpoly(binwidth = 0.5) +
  facet_grid(model ~ sex) +
  theme

ampresfig1

# Visualizing pattern of residuals for lm and gam model
ampresfig2 <- comb %>%
  filter(type == "resid") %>%
  ggplot(aes(x = age, y = value)) +
  geom_point() +
  geom_smooth(method = "loess") +
  geom_ref_line(h = 0) +
  facet_grid(model ~ sex) + 
  theme

ampresfig2

```

```{r amp_all_setup, include = FALSE}

# Create a dataset that nests all of the datasets according to
# gender and imputation. So with 2 genders and 50 imps, there will be
# 100 groups/dataframes
impsexamp <- dfimp %>% 
  filter(.imp != 0) %>%
  group_by(.imp, sex) %>%
  nest()

# Produce nice summary of the models
tidysumamp <- impsexamp %>% # A model will be applied to all imputations and sex
  mutate(model = map(data, ampmodel), #ampmodel is function for nlme amp model
         modelsum = map(model, ~tidy(.x, effects = "fixed")), # Obtaining all the B's and intercepts from the models
         bvar = map(model, bvar), # Obtaining between subject variance using function bvar
         wvar = map(model, wvar)) # Obtaining within subject variance using function wvar

# Unnest tidy summary for data on slope and intercept
# of all the models
modslopeint <- tidysumamp %>%
  unnest(modelsum, .drop = TRUE)

# Unnest tidy summary for data on within individual variance
modwvar <- tidysumamp %>%
  unnest(wvar, .drop = TRUE)

# Uneest tidy summary for data on between individual variance
modbvar <- tidysumamp %>%
  unnest(bvar, .drop = TRUE)

```

<br>

###### **Figure 3. Extractions of model slopes, intercepts, intercept variance and residual variance for each imputed dataset**

<br>

```{r amp_model_plots, echo = FALSE}

# Plot all of the beta's for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
slopeplot <- modslopeint %>%
  filter(term == "agemean") %>%
  ggplot(aes(x = .imp, y = estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Slope of regression line") +
  theme

slopeplot

# Plot all of the intercepts for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
interplot <- modslopeint %>%
  filter(term == "(Intercept)") %>%
  ggplot(aes(.imp, estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Partner age for average age") +
  theme

interplot

# Plot each of the residual variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
wvarplot <- modwvar %>%
  ggplot(aes(.imp, wsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprwsd,
                      ymin = lwrwsd)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Within-Subject SD") +
  theme

wvarplot

# Plot each of the between subject variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
bvarplot <- modbvar %>%
  ggplot(aes(.imp, bsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprbsd,
                      ymin = lwrbsd)) +
  facet_grid(sex ~ .) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Between-Subject SD") +
  theme

bvarplot
```

<br>

###### **Figure 4. Fraction of relationships with different partner age groups, among those who are HIV positive**

<br>

```{r age_hiv_fig, echo = FALSE}
# Create dataframe that summarizes the proportion of relationships
# in different partner age groups for people who are HIV
# positive
hivbyage <- impsexamp %>%
  unnest() %>%
  ungroup() %>%
  filter(.imp == n & hiv == "Positive") %>%
  group_by(sex, agepgroup) %>%
  summarise(n = n()) %>%
  mutate(prop = round((n / sum(n)) * 100, 2))

# Barplot of fraction of relationships in different partner age groups  
hivageplot <- hivbyage %>%
  ggplot(aes(x = agepgroup, y = prop, fill = sex)) +
  geom_bar(stat = "identity",
           position = position_dodge()) +
  xlab("Age group of partner") +
  ylab("Proportion of relationships") +
  scale_fill_brewer(palette = "Dark2") +
  theme

hivageplot
  
```

```{r amp_hiv_fig_setup, include = FALSE}
# This chunk sets up the data in order to visualize the age 
# mixing pattern among those who are HIV positive

# Smaller datasets
dfamphivm <- dfamp %>%
  filter(sex == "Male" & hiv == "Positive")

dfamphivw <- dfamp %>%
  filter(sex == "Female" & hiv == "Positive")


# Now fit separate models for men and women
amphivmodm <- lme(agep ~ agemean, 
           data = dfamphivm, 
           random = ~1 | id,  
           method = "REML")

amphivmodw <- lme(agep ~ agemean, 
           data = dfamphivw, 
           random = ~1 | id,
           method = "REML")


# Add the predicted values to the dataset
dfamphivm <- dfamphivm %>%
  mutate(pred = predict(amphivmodm, newdata = ., level = 0))

dfamphivw <- dfamphivw %>%
  mutate(pred = predict(amphivmodw, newdata = ., level = 0)) 

#Combine both datasets again
comb <- bind_rows(dfamphivm, dfamphivw) 
  
```

<br>

###### **Figure 5. Age mixing pattern for those who are HIV positive**

<br>

```{r amp_hiv_fig, echo = FALSE}
# Visualizing the age mixing pattern among those
# who are HIV positive
amphivfig <- comb %>%
  ggplot(aes(x = age, y = pred)) +
  geom_point(aes(x = age, 
                 y = agep, 
                 color = missagep), 
             position = position_jitter(width = 0.75, height = 0.75),
             size = 1) +
  geom_abline(size = 1, 
              aes(intercept = 0, slope = 1, linetype = "Same age"), 
              show.legend = FALSE) +
  geom_line(aes(linetype = "Population mean"), 
            size = 1) +
  facet_wrap(~ sex) + 
  scale_y_continuous(name = "Partner's ages") +
  scale_color_manual('Imputation Status', values = c('grey70', 'grey42')) +
  scale_linetype_manual('Lines', values = c("Population mean" = 1, 'Same age' = 2)) +
  xlab("Participant's age") +
  guides(linetype = guide_legend(keywidth = 2, keyheight = 1)) +
  theme

amphivfig

```


```{r bw_hiv_setup, include = FALSE}

# Determine the degrees of freedom for the age spline in model
# Randomly select one dataset
set.seed(5555)
n_bw <- sample(1:imp, 1)

# Take out participants who only had 1 relationship in the previous
# 12 months
dfbw <- partdfimp %>%
  filter(.imp == n_bw,
         relcount > 1)

# Stratify dataframes by sex
dfbwm <- dfbw %>%
  filter(sex == "Male")

dfbww <- dfbw %>%
  filter(sex == "Female")

# GAM models
bwmodm <- gam(bridgewidth ~ hiv + s(age) + race,
                 data = dfbwm,
                 family = nb()) #edf is rounded to 2

bwmodw <- gam(bridgewidth ~ hiv + s(age) + race,
                 data = dfbww,
                 family = nb()) #edf is rounded to 2

# Now create negative binomial models for each imputed dataset, by gender
# Exclude complete cases dataframe
impsex <- partdfimp %>% 
  filter(.imp != 0) %>%
  group_by(.imp, sex) 

# Summarize the median and IQR of BW by sex and dataset
# Among those with more than 1 partner
bwbyimpsex <- impsex %>%
  filter(relcount > 1) %>%
  summarise(n = n(),
            Median = median(bridgewidth),
            lwr = summary(bridgewidth)[[2]],
            upr = summary(bridgewidth)[[5]])

# Nest all the datasets by sex and imputation
impsexbw <- impsex %>% 
  nest()
 
tidysumbw <- impsexbw %>% # A model will be applied to all imputations and sex
  mutate(model = map(data, ~ bwmodel(.x)), # bwmodel is function for nb bw model, model as stored as var in nested df
         modelsum = map(model, tidy), # Create tidy summary of each model and store as modelsum var in nested df
         splinepred = map2(data, model, nbsplinepreds)) # Create predictions across dif vals of age (our spline var) and store as
                                                      # var in our nested df

# Unnest the tidy summary, to see the tidy model estimates for each model
bwmodcoef <- tidysumbw %>%
  unnest(modelsum, .drop = TRUE) %>%
  ungroup() %>%
  mutate(lwr = estimate - 2 * std.error,
         upr = estimate + 2 * std.error,
         irr = exp(estimate),
         lwrirr = exp(lwr),
         uprirr = exp(upr))

# Unnest the tidy summary, to see the tidy model predictions for values of age
# for each model
bwmodpred <- tidysumbw %>%
  unnest(splinepred, .drop = TRUE)

# Now we want to produce a pooled beta for HIV according to 
# Rubin's rules. To do this we use mice functions

part <- partdfimp %>% # Take original participant-level imputed df
  filter(relcount > 1) %>% # Only participants who had more than one rel
  as.mids() # Create mids object

bwmodpoolm <- part %>%
  with(glm.nb(bridgewidth ~ hiv + splines::ns(age, 2) + race,
              subset = (sex == "Male"))) %>%
  pool() %>% # Pool coefficients according to Rubin's Rules
  summary() %>%
  exp() %>%
  round(2) 

bwmodpoolw <- part %>%
  with(glm.nb(bridgewidth ~ hiv + splines::ns(age, 2) + race, 
              subset = (sex == "Female"))) %>%
  pool() %>% # Pool according to Rubin's Rules
  summary() %>%
  exp() %>%
  round(2) 

menEBWR <- bwmodpoolm[2, 1] # Extract HIV EBWR 
menEBWRlwr <- bwmodpoolm[2, 6] # Extract HIV lower CI limit
menEBWRupr <- bwmodpoolm[2, 7] # Extract HIV upper CI limit
womenEBWR <- bwmodpoolw[2, 1]
womenEBWRlwr <- bwmodpoolw[2, 6]
womenEBWRupr <- bwmodpoolw[2, 7]
```

<br>

####### **Figure 6. Distribution of bridge widths for each imputed dataset, by sex and HIV status**

<br>

```{r bw_density_fig, echo = FALSE}

# Check spread of bridgwidths for each grouped dataset
bwfig <- impsex %>%
  ggplot(aes(x = bridgewidth, group = .imp)) +
  geom_density(adjust = 2) +
  facet_grid(hiv ~ sex) +
  xlab("Bridgewidth") +
  ylab("Density") +
  theme

bwfig
```

<br>

###### **Figure 7. Model coefficients for relationship between HIV and bridge width. Results from negative binomial models with bridge width as the outcome. This is only among participants who reported more than 1 relationship in the previous year**

<br>

```{r EBWR_fig, echo = FALSE}

ticks <- c(0.5, 1.0, 2.0, 4.0)

label <- c(
  paste0("Pooled EBWR: ", menEBWR, "(", menEBWRlwr, "-", menEBWRupr, ")"),
  paste0("Pooled EBWR: ", womenEBWR, "(", womenEBWRlwr, "-", womenEBWRupr, ")")
)

# Plot all the EBWR's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
bwhivfig <- bwmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, irr)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = uprirr,
                      ymin = lwrirr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("Expected Bridge Width Ratio") +
  scale_y_log10(breaks = ticks) +
  annotate("text", x = 40, y = 6.5, label = label) +
  theme

bwhivfig
```

<br>

Overall, among men the expected count of bridge widths for those with HIV was `r menEBWR` times higher than those who were HIV negative. Among women it was `r womenEBWR` times higher. 

<br>

###### **Figure 8. Expected bridge widths for different values of age (the spline variable), by gender. Each line represents a different imputed dataset.**

<br>

```{r bw_age_fig, echo = FALSE}

# Plot expected BW's for different values of age (or spline variable)
# Spaghetti plot to show each line for dataset by gender
bwagefig <- bwmodpred %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Expected Bridge Width") +
  theme

bwagefig

```


```{r ad_hiv_setup, include = FALSE}
# Determine the degrees of freedom for the age spline in model
# Randomly select one dataset
set.seed(6022)
n_ad <- sample(1:imp, 1)

# Take out other datasets and relationships that started
# more than 12 months ago
dfad <- dfimp %>%
  filter(.imp == n_ad, 
         start == "Last year")

# Stratified data frames by sex
dfadm <- dfad %>%
  filter(sex == "Male")

dfadw <- dfad %>%
  filter(sex == "Female")

# Stratified GAMM models
admodm <- gamm(agedif ~ s(age) + hiv + race, 
           data = dfadm, 
           random = list(id = ~1))

admodw <- gamm(agedif ~ s(age) + hiv + race, 
           data = dfadw, 
           random = list(id = ~1))

summary(admodm$gam) # EDF is rounded to 4
summary(admodw$gam) # EDF is rounded to 1

# Create grouped dataframe, without complete cases dataset
# Only want relationships that started last year
# The reason there are differing numbers of observations in each
# df, are because there were some missing genders in the original df.
# In other words, the differing numbers are not related to relationship start
impsexad <- dfimp %>%
  filter(.imp != 0, 
         start == "Last year") %>%
  group_by(.imp, sex) %>%
  nest()

# Does HIV status predict agegaps in relationships started after HIV diagnosis?
# In the past 12 months

tidysumad <- impsexad %>%
  mutate(model = map2(data, sex, admodel),
         modelsum = map(model, ~tidy(.x, effects = "fixed")),
         splinepred = map2(data, model, lmesplinepreds))

tidysumad

```

<br>

###### **Figure 9. Distribution of age differences in relationships that started in the previous 12 months, by gender and imputation dataset**

<br>

```{r ad_hiv_fig, echo = FALSE}

adhivfig <- impsexad %>%
  unnest() %>%
  ggplot(aes(x = agedif, group = .imp)) +
  geom_density() +
  facet_grid(. ~ sex) +
  theme

adhivfig

```


```{r close, include = FALSE}
# ====================================================
# Detach libraries and remove objects from environment
# ====================================================
Vectorize(detach)(name = paste0("package:", c("tidyverse", "mice",
                                              "mgcv", "modelr", "broom", "nlme", 
                                              "MASS", "magrittr")), 
                  unload = TRUE, 
                  character.only = TRUE)

rm(list=ls())

```

