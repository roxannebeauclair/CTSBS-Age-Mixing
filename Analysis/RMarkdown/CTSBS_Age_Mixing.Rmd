---
title: "CTSBS Age-Mixing"
author: "Roxanne Beauclair"
date: '`r format(Sys.Date(), "%d %b %Y")`'
output: html_document
---

```{r setup, include = FALSE}
# ===================
# Relative file paths
# ===================
wd <- "/Users/roxannebeauclair/Documents/Analytical Projects/PhD/CTSbS Age Mixing/Analysis"
cdata <- paste0(wd, "/Data/Cleaned")

concurdata <- paste0(cdata, "/ctsbs_concur_added_data.rda")
imputedata <- paste0(cdata, "/ctsbs_impute_data.rda")
imputedatapart <- paste0(cdata, "/ctsbs_impute_data_part.rda")

fxn <- paste0(wd, "/Scripts/00-Functions.R")

# ====================
# Loading dependencies
# ====================
source(fxn)

# magrittr: for use of %>% operator
# tidyverse: for data management functions
# mice: for MI


InstallLoad("magrittr", "MASS", "tidyverse", 
            "mice","nlme", "lme4", "modelr",
            "mgcv", "gamm4", "broom", "splines", 
            "mediation", "forcats", "Gmisc", "htmlTable")

# =============
# Load datasets
# =============
load(imputedata)
load(imputedatapart)
load(concurdata)

# ====================
# Set specific global options
# ====================

# Set theme for plots
theme <- theme(axis.title.x = element_text(face = "bold", size = 10),
             axis.text.x  = element_text(angle = 0, face = "bold",
                                         colour = "black", size = 8),
             axis.title.y = element_text(face = "bold", size = 10),
             axis.text.y = element_text(angle = 0, 
                                        face = "bold", 
                                        colour = "black", 
                                        hjust = 0.5,
                                        size = 8),
             plot.title = element_text(lineheight = .8, face = "bold"),
             panel.grid.major = element_line(colour = 'grey82'),
             panel.grid.minor = element_line(colour = NA),
             panel.background = element_rect(fill = 'white'),
             strip.background = element_rect(fill = 'white'),
             strip.text = element_text(size = 8, face = "bold"),
             legend.title = element_text(colour = "black", size = 9, face = "bold"),
             legend.text = element_text(size = 8, face = "bold"),
             plot.margin = unit(c(1.5,1,1,1), "lines"))


# Initialize table counter
options(show.signif.stars = F)
```


```{r df_description, include = FALSE}
# How many exclusions due to sexuality
df1 <- df %>%
  filter(sexorientation != "both" | is.na(sexorientation)) %>%
  filter((sex == "Male" & sexorientation == "Women") |
           ((sex == "Female" & sexorientation == "Men")) |
              (is.na(sex))) 

n_sexuality <- nrow(df) - nrow(df1)

# How many exclusions due to race
df2 <- df1 %>%
  filter(race == "Coloured" | 
           race == "Black" |
           is.na(race)) 

n_race <- nrow(df1) - nrow(df2)

# How many exclusions due to no parter reported
df3 <- df2 %>%
  filter(partner != 0) 

n_nopart <- nrow(df2) - nrow(df3)

# How many relationships left
rels_left <- nrow(df3)

# How many participants left
parts_left <- df3 %>%
  distinct(id) %>%
  nrow()

imp <- max(as.integer(dfimp$.imp)) - 1

# How many relationships started in the last year
df4 <- df3 %>%
  mutate(start = as.factor(ifelse(!is.na(start), "Last year", "before last year"))) %>%
  filter(start == "Last year")

rels_last_year <- nrow(df4)

# How many participants had more than 1 relationship
df5 <- partdfimp %>%
  filter(.imp ==23) %>%
  filter(relcount > 1)

parts_many_partner <- nrow(df5)

rm(df, df1, df2, df3, df4, df5)

```

<br>

**Research questions:** 

1. Describe the age-mixing pattern in the CTSBS population. Does the age-mixing pattern of HIV positive participants differ from HIV negative participants?
2. At the individual-level are large ranges in partner ages (bridgewidths) associated with HIV status of a participant?

Before conducting imputations, I excluded participants who said their sexual preferences were for "both" genders or the same gender (n = `r n_sexuality`). I further excluded people who did not identify as black or coloured (n = `r n_race`) and people who did not report partners in the previous year (n = `r n_nopart`). Participants who had missing observations on those characteristics were left in the dataset. This left `r rels_left` relationships reported by `r parts_left` participants. Of the `r parts_left` participants, `r parts_many_partner` reported more than one relationship in the previous year. I imputed `r imp` datasets using the random forest method for continuous and nominal categorical variables and the "polr" method for our ordinal variables. 

```{r amp_setup, include = FALSE}

# What is the age mixing pattern?
set.seed(4762)
n <- sample(1:imp, 1)

# Smaller datasets
dfamp <- dfimp %>%
  filter(.imp == n) %>%
  select(id, age, age0, agep, sex,
         missage, missagep, hiv) 

# HIV negative
dfampm <- dfamp %>%
  filter(sex == "Male" & hiv == "Negative")

dfampw <- dfamp %>%
  filter(sex == "Female" & hiv == "Negative")


# Now fit separate models for men and women
ampmodm <- lme(agep ~ age0, 
           data = dfampm, 
           random = ~1 | id,
           weights = varPower(value = 0.5, form = ~age0 + 1),
           method = "REML")

ampmodw <- lme(agep ~ age0, 
           data = dfampw, 
           random = ~1 | id,
           weights = varPower(value = 0.5, form = ~age0 + 1),
           method = "REML")

ampmodm2 <- lme(agep ~ age0, 
           data = dfampm, 
           random = ~1 | id,
           method = "REML")

ampmodw2 <- lme(agep ~ age0, 
           data = dfampw, 
           random = ~1 | id,
           method = "REML")

# Compare fit of male negative models with and without 
# power variance structure
aicampmodm1 <- AIC(ampmodm)
aicampmodm2 <- AIC(ampmodm2)

# Compare female negative models
aicampmodw1 <- AIC(ampmodw)
aicampmodw2 <- AIC(ampmodw2)

# Add the predicted values and residuals to the dataset
dfampm <- dfampm %>%
  mutate(pred = predict(ampmodm, newdata = ., level = 0)) %>%
  add_residuals(ampmodm, var = "resid")

dfampw <- dfampw %>%
  mutate(pred = predict(ampmodw, newdata = ., level = 0)) %>%
  add_residuals(ampmodw, var = "resid") 

#Combine both datasets again
comb <- bind_rows(dfampm, dfampw)

# For only those with HIV

dfamphiv <- dfimp %>%
  filter(.imp == n) %>%
  select(id, age, age0, agep, sex,
         missage, missagep, hiv)

dfamphivm <- dfamphiv %>%
  filter(sex == "Male" & hiv == "Positive")

dfamphivw <- dfamphiv %>%
  filter(sex == "Female" & hiv == "Positive")


# Now fit separate models for men and women
amphivmodm <- lme(agep ~ age0, 
           data = dfamphivm, 
           random = ~1 | id,
           weights = varPower(value = 0.5, form = ~age0 + 1),
           method = "REML")

amphivmodw <- lme(agep ~ age0, 
           data = dfamphivw, 
           random = ~1 | id,
           weights = varPower(value = 0.5, form = ~age0 + 1),
           method = "REML")

amphivmodm2 <- lme(agep ~ age0, 
           data = dfamphivm, 
           random = ~1 | id,
           method = "REML")

amphivmodw2 <- lme(agep ~ age0, 
           data = dfamphivw, 
           random = ~1 | id,
           method = "REML")

# Compare fit of male positive models with and without 
# power variance structure
aicamphivmodm1 <- AIC(amphivmodm)
aicamphivmodm2 <- AIC(amphivmodm2)

# Compare female positive models
aicamphivmodw1 <- AIC(amphivmodw)
aicamphivmodw2 <- AIC(amphivmodw2)


# Add the predicted values to the dataset
dfamphivm <- dfamphivm %>%
  mutate(pred = predict(amphivmodm, newdata = ., level = 0))%>%
  add_residuals(amphivmodm, var = "resid")

dfamphivw <- dfamphivw %>%
  mutate(pred = predict(amphivmodw, newdata = ., level = 0)) %>%
  add_residuals(amphivmodw, var = "resid")

#Combine both male and female HIV datasets again
comb2 <- bind_rows(dfamphivm, dfamphivw) 

# Now add the HIV dataset to the negative dataset
comb_all <- bind_rows(comb, comb2)
  
```

<br>

### **AGE-MIXING PATTERN**

<br>

Here I used linear mixed effects models that were stratified by sex and contained a random intercept for the participant. For the plots, I randomly selected an imputed dataset to visualize the pattern in that population. Heteroskedastic variance is now taken into account in the models that produced these predictions.

<br>

###### **Figure 1. Age mixing pattern for randomly selected imputed dataset. The top row represents the male and female age mixing patterns HIV negative study population, while the bottom row is for only those with HIV**

<br>

```{r amp_fig, echo = FALSE, warning = FALSE}
# Figure visualizing the age mixing pattern
ampfig <- comb_all %>%
  ggplot(aes(x = age, y = pred)) +
  geom_point(aes(x = age, 
                 y = agep, 
                 color = missagep), 
             position = position_jitter(width = 0.75, height = 0.75),
             size = 1) +
  geom_abline(size = 1, 
              aes(intercept = 0, slope = 1, linetype = "Same age"), 
              show.legend = FALSE) +
  geom_line(aes(linetype = "Population mean"), 
            size = 1) +
  facet_grid(hiv ~ sex) + 
  scale_y_continuous(name = "Partner's ages") +
  scale_color_manual('Imputation Status', values = c('grey70', 'grey42')) +
  scale_linetype_manual('Lines', values = c("Population mean" = 1, 'Same age' = 2)) +
  xlab("Participant's age") +
  guides(linetype = guide_legend(keywidth = 2, keyheight = 1)) +
  theme

ampfig

```


```{r amp_res_fig, include = FALSE, warning = FALSE}
# Visualizing spread of residuals for lm 
ampresfig1 <- comb_all %>%
  ggplot(aes(resid)) +
  geom_freqpoly(binwidth = 0.5) +
  facet_grid(hiv ~ sex) +
  theme

ampresfig1

# Visualizing pattern of residuals for lm 
ampresfig2 <- comb_all %>%
  ggplot(aes(x = age, y = resid)) +
  geom_point() +
  geom_smooth(method = "loess") +
  geom_ref_line(h = 0) +
  facet_grid(hiv ~ sex) + 
  theme

ampresfig2

```

```{r amp_all_setup, include = FALSE, warning = FALSE}

# Create a dataset that nests all of the datasets according to
# gender, imputation, and hiv status. So with 2 genders, 50 imps, and 2 hiv status,
# there will be 200 groups/dataframes

impsexhivamp <- dfimp %>%
  filter(.imp != 0)%>%
  group_by(.imp, sex, hiv) %>%
  nest()

# Produce nice summary of the models
# A model will be applied to all imputations, sex, and hiv subgroups
tidysumamp <- impsexhivamp %>%
  mutate(model = map(data, ampmodel), #ampmodel is function for nlme amp model
         modelsum = map(model, ~tidy(.x, effects = "fixed")), # Obtaining all the b's and intercepts from the models
         bvar = map(model, bvar), # Obtaining between subject variance using function bvar
         wvar = map(model, wvar), # Obtaining within subject variance using function wvar
         power = map(model, power), # Obtaining power coefficient using function power
         model2 = map(data, ampmodel2),
         modelsum2 = map(model2, ~tidy(.x, effects = "fixed")),
         bvar2 = map(model2, bvar2),
         wvar2 = map(model2, wvar2))
```

```{r slope_int_setup, include = FALSE, warning = FALSE}
# Unnest tidy summary for (lme) data on slope and intercept
# of all the models
modslopeint <- tidysumamp %>%
  unnest(modelsum, .drop = TRUE)

# Calculate difference between estimate, 
# then fraction of differences
slopeintdif <- modslopeint %>%
  select(-std.error, -statistic, -p.value) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, estimate) 

# Fraction of imputed dfs where differenes between 
# slopes are <= 0. 
gendifslopesum <- slopeintdif %>%
  filter(term == "age0") %>%
  mutate(gendifneg = Female_Negative - Male_Negative, # Ha: Female slopes larger than males
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# All slopes are different between genders among HIV negative people
gendifslopeprop <- 0.00

# Fraction of imputed dfs where differenes between 
# intercepts are <= 0. 
gendifintsum <- slopeintdif %>%
  filter(term == "(Intercept)") %>%
  mutate(gendifneg = Female_Negative - Male_Negative, # Ha: Female intercepts larger than males
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# All intercepts are different between genders among HIV negative people
gendifintprop <- 0.00

hivdifmslopesum <- slopeintdif %>%
  filter(term == "age0") %>%
  mutate(hivdifm = Male_Negative - Male_Positive, # Ha: HIV negative males larger than HIV pos males
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of slopes which are <= 0 between Hiv neg and pos men
hivdifmslopeprop <- hivdifmslopesum$prop[2]

hivdifmintsum <- slopeintdif %>%
  filter(term == "(Intercept)") %>%
  mutate(hivdifm = Male_Positive - Male_Negative, # Ha: HIV pos males larger than HIV neg males
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of intercept differences <=0
hivdifmintprop <- 0.00

hivdifwslopesum <- slopeintdif %>%
  filter(term == "age0") %>%
  mutate(hivdifw = Female_Negative - Female_Positive, # Ha: HIV negative males larger than HIV pos males
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of slopes which are <= 0 between Hiv neg and pos women
hivdifwslopeprop <- 0.00

hivdifwintsum <- slopeintdif %>%
  filter(term == "(Intercept)") %>%
  mutate(hivdifw = Female_Positive - Female_Negative, # Ha: HIV pos females larger than HIV neg females
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of intercept differences <=0
hivdifwintprop <- 0.00

# ===========================
# LMER models
# ===========================

# Unnest tidy summary for (lmer) data on slope and intercept
# of all the models
modslopeint2 <- tidysumamp %>%
  unnest(modelsum2, .drop = TRUE)

slopeintdif2 <- modslopeint2 %>%
  select(-std.error, -statistic) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, estimate) 

# Fraction of imputed dfs where differenes between 
# slopes are <= 0. 
gendifslopesum2 <- slopeintdif2 %>%
  filter(term == "age0") %>%
  mutate(gendifneg = Female_Negative - Male_Negative, # Ha: Female slopes larger than males
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# All slopes are different between genders among HIV negative people
gendifslopeprop2 <- 0.00

# Fraction of imputed dfs where differenes between 
# intercepts are <= 0. 
gendifintsum2 <- slopeintdif2 %>%
  filter(term == "(Intercept)") %>%
  mutate(gendifneg = Female_Negative - Male_Negative, # Ha: Female intercepts larger than males
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# All intercepts are different between genders among HIV negative people
gendifintprop2 <- 0.00

hivdifmslopesum2 <- slopeintdif2 %>%
  filter(term == "age0") %>%
  mutate(hivdifm = Male_Negative - Male_Positive, # Ha: HIV negative males larger than HIV pos males
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of slopes which are <= 0 between Hiv neg and pos men
hivdifmslopeprop2 <- hivdifmslopesum2$prop[2]

hivdifmintsum2 <- slopeintdif2 %>%
  filter(term == "(Intercept)") %>%
  mutate(hivdifm = Male_Positive - Male_Negative, # Ha: HIV pos males larger than HIV neg males
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of intercept differences <=0
hivdifmintprop2 <- 0.00

hivdifwslopesum2 <- slopeintdif2 %>%
  filter(term == "age0") %>%
  mutate(hivdifw = Female_Negative - Female_Positive, # Ha: HIV negative males larger than HIV pos males
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of slopes which are <= 0 between Hiv neg and pos women
hivdifwslopeprop2 <- 0.00

hivdifwintsum2 <- slopeintdif2 %>%
  filter(term == "(Intercept)") %>%
  mutate(hivdifw = Female_Positive - Female_Negative, # Ha: HIV pos females larger than HIV neg females
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of intercept differences <=0
hivdifwintprop2 <- 0.00
```

```{r wvar_setup, include = FALSE, warning = FALSE}

# Unnest tidy summary for (lme) data on within individual variance
modwvar <- tidysumamp %>%
  unnest(wvar, .drop = TRUE)

wvardif <- modwvar %>%
  select(-lwrwsd, -uprwsd) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, wsd) 

gendifwvarsum <- wvardif %>%
  mutate(gendifneg = Female_Negative - Male_Negative,
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing neg Females to males
gendifwvarprop <- gendifwvarsum$prop[2]

hivdifmwvarsum <- wvardif %>%
  mutate(hivdifm = Male_Positive - Male_Negative,
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing hiv pos males to hiv neg males
hivdifmwvarprop <- hivdifmwvarsum$prop[2]

hivdifwwvarsum <- wvardif %>%
  mutate(hivdifw = Female_Positive - Female_Negative,
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing hiv pos females to hiv neg females
hivdifwwvarprop <- 0.00

# ====================
# LMER
# ====================
# Unnest tidy summary for (lmer) data on within individual variance
modwvar2 <- tidysumamp %>%
  unnest(wvar2, .drop = TRUE)

wvardif2 <- modwvar2 %>%
  select(-lwrwsd, -uprwsd) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, wsd) 

gendifwvarsum2 <- wvardif2 %>%
  mutate(gendifneg = Female_Negative - Male_Negative,
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing neg Females to males
gendifwvarprop2 <- gendifwvarsum2$prop[2]

hivdifmwvarsum2 <- wvardif2 %>%
  mutate(hivdifm = Male_Positive - Male_Negative,
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing hiv pos males to hiv neg males
hivdifmwvarprop2 <- hivdifmwvarsum2$prop[2]

hivdifwwvarsum2 <- wvardif2 %>%
  mutate(hivdifw = Female_Positive - Female_Negative,
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing hiv pos females to hiv neg females
hivdifwwvarprop2 <- 0.00
```

```{r bvar_setup, include = FALSE, warning = FALSE}

# Uneest tidy summary for (lme) data on between individual variance
modbvar <- tidysumamp %>%
  unnest(bvar, .drop = TRUE)

bvardif <- modbvar %>%
  select(-lwrbsd, -uprbsd) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, bsd) 

gendifbvarsum <- bvardif %>%
  mutate(gendifneg = Male_Negative - Female_Negative, # Ha: Male larger than females in neg
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of bvars that were <= 0 comparing neg males to females
gendifbvarprop <- 0.00

hivdifmbvarsum <- bvardif %>%
  mutate(hivdifm = Male_Negative - Male_Positive, # Ha: Male neg larger than pos
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of bvars that were <= 0 comparing hiv neg males to hiv pos males
hivdifmbvarprop <- 0.00

hivdifwbvarsum <- bvardif %>%
  mutate(hivdifw = Female_Negative - Female_Positive, # Ha: Female neg larger than pos
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing hiv pos females to hiv neg females
hivdifwbvarprop <- 0.00

# ===================
# LMER
# ===================

# Uneest tidy summary for (lmer) data on between individual variance
modbvar2 <- tidysumamp %>%
  unnest(bvar2, .drop = TRUE)

bvardif2 <- modbvar2 %>%
  select(-lwrbsd, -uprbsd) %>%
  unite(subpop, sex, hiv) %>%
  spread(subpop, bsd) 

gendifbvarsum2 <- bvardif2 %>%
  mutate(gendifneg = Male_Negative - Female_Negative, # Ha: Male larger than females in neg
         gendifnegind = as.factor(ifelse(gendifneg <= 0, "Null", "Diff"))) %>%
  group_by(gendifnegind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of bvars that were <= 0 comparing neg males to females
gendifbvarprop2 <- 0.00

hivdifmbvarsum2 <- bvardif2 %>%
  mutate(hivdifm = Male_Negative - Male_Positive, # Ha: Male neg larger than pos
         hivdifmind = as.factor(ifelse(hivdifm <= 0, "Null", "Diff"))) %>%
  group_by(hivdifmind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of bvars that were <= 0 comparing hiv neg males to hiv pos males
hivdifmbvarprop2 <- 0.00

hivdifwbvarsum2 <- bvardif2 %>%
  mutate(hivdifw = Female_Negative - Female_Positive, # Ha: Female neg larger than pos
         hivdifwind = as.factor(ifelse(hivdifw <= 0, "Null", "Diff"))) %>%
  group_by(hivdifwind) %>%
  summarize(n = n()) %>%
  mutate(prop = round(n / sum(n), 2))

# Fraction of wvars that were <= 0 comparing hiv pos females to hiv neg females
hivdifwbvarprop2 <- 0.00


```

```{r power_setup, include = FALSE, warning = FALSE}

# Unnest tidy summary for (lme) data on power coefficient
modpower <- tidysumamp %>%
  unnest(power, .drop = TRUE)

```

<br>

###### **Figure 2. Extractions of model slopes, intercepts, intercept variance and residual variance for each imputed dataset. The top row represents the male and female age mixing patterns in the whole study population, while the bottom row is for only those with HIV**

<br>

```{r amp_model_slope_plot, echo = FALSE, warning = FALSE, fig.height = 8}

# Plot all of the beta's for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
slopeplot <- modslopeint %>%
  filter(term == "age0") %>%
  ggplot(aes(x = .imp, y = estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Slope of regression line (nlme)") +
  theme

slopeplot
```

<br>

Fraction of slope differences <= 0 for different alternative hypotheses:

* Ha 1: Slopes of women are larger than slopes of men in HIV negative participants: `r gendifslopeprop`
* Ha 2: HIV negative men have larger slopes than HIV positive men: `r hivdifmslopeprop`
* Ha 3: HIV negative women have larger slopes than HIV positive women: `r hivdifwslopeprop`


```{r amp_model_slope_plot2, echo = FALSE, warning = FALSE, fig.height = 8}

# Plot all of the beta's for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
slopeplot2 <- modslopeint2 %>%
  filter(term == "age0") %>%
  ggplot(aes(x = .imp, y = estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Slope of regression line (lme4)") +
  theme

slopeplot2
```

<br>

Fraction of slope differences <= 0 for different alternative hypotheses:

* Ha 1: Slopes of women are larger than slopes of men in HIV negative participants: `r gendifslopeprop2`
* Ha 2: HIV negative men have larger slopes than HIV positive men: `r hivdifmslopeprop2`
* Ha 3: HIV negative women have larger slopes than HIV positive women: `r hivdifwslopeprop2`

```{r amp_model_intercept_plot, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot all of the intercepts for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
interplot <- modslopeint %>%
  filter(term == "(Intercept)") %>%
  ggplot(aes(.imp, estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Partner age for 15 year olds (nlme)") +
  theme

interplot
```

<br>

Fraction of intercept differences <= 0 for different alternative hypotheses:

* Ha: Women have larger intercepts than men among HIV negative participants: `r gendifintprop`
* Ha: HIV positive men have larger intercepts than HIV negative men: `r hivdifmintprop`
* Ha: HIV positive women have larger intercepts than HIV negative women: `r hivdifwintprop`

```{r amp_model_intercept_plot2, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot all of the intercepts for age mixing pattern in 
# each of the 100 datasets (by imputation and gender)
interplot2 <- modslopeint2 %>%
  filter(term == "(Intercept)") %>%
  ggplot(aes(.imp, estimate)) +
  geom_point() +
  geom_pointrange(aes(ymax = estimate + 2 * std.error,
                      ymin = estimate - 2 * std.error)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Partner age for 15 year olds (lme4)") +
  theme

interplot2
```


<br>

Fraction of intercept differences <= 0 for different alternative hypotheses:

* Ha: Women have larger intercepts than men among HIV negative participants: `r gendifintprop2`
* Ha: HIV positive men have larger intercepts than HIV negative men: `r hivdifmintprop2`
* Ha: HIV positive women have larger intercepts than HIV negative women: `r hivdifwintprop2`

```{r amp_model_wvar_plot, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot each of the residual variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
wvarplot <- modwvar %>%
  ggplot(aes(.imp, wsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprwsd,
                      ymin = lwrwsd)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Within-Subject SD (nlme)") +
  theme

wvarplot
```

<br>

Fraction of within-subject variation differences <= 0 for different alternative hypotheses:

* Ha: Women have larger within-subject standard errors than men among HIV negative participants: `r gendifwvarprop`
* Ha: HIV positive men have larger within-subject standard errors than negative men: `r hivdifmwvarprop`
* Ha: HIV positive women have larger within-subject standard errors than negative women: `r hivdifwwvarprop`


```{r amp_model_wvar_plot2, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot each of the residual variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
wvarplot2 <- modwvar2 %>%
  ggplot(aes(.imp, wsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprwsd,
                      ymin = lwrwsd)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  xlab("Imputation") +
  ylab("Within-Subject SD (lme4)") +
  theme

wvarplot2
```

<br>

Fraction of within-subject variation differences <= 0 for different alternative hypotheses:

* Ha: Women have larger within-subject standard errors than men among HIV negative participants: `r gendifwvarprop2`
* Ha: HIV positive men have larger within-subject standard errors than negative men: `r hivdifmwvarprop2`
* Ha: HIV positive women have larger within-subject standard errors than negative women: `r hivdifwwvarprop2`


```{r amp_model_bvar_plot, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot each of the between subject variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
bvarplot <- modbvar %>%
  ggplot(aes(.imp, bsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprbsd,
                      ymin = lwrbsd)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 20)) +
  xlab("Imputation") +
  ylab("between-Subject SD (nlme)") +
  theme

bvarplot
```

<br>

Fraction of between-subject variation differences <= 0 for different alternative hypotheses:

* Ha: Men have larger between-subject standard errors than women among HIV negative participants: `r gendifbvarprop`
* Ha: HIV negative men have larger between-subject standard errors than HIV positive men: `r hivdifmbvarprop`
* Ha: HIV negative women have larger between-subject standard errors than HIV positive women: `r hivdifwbvarprop`

<br>

For some of the models on the some datasets (e.g. impution 9 in the HIV positive female sub-population), I recieved this error message when trying to obtain the CIs for the between-subject (intercept) SD: "cannot get confidence intervals on var-cov components: Non-positive definite approximate variance-covariance". According to Jose Pinheiro, this "indicates that, although the optimization algorithm converged (according to the criteria defined in the ms() function), the Hessian matrix calculated at the converged values was not negative-definite
and therefore an approximate covariance matrix for the MLE's could not be obtained. This is generally caused by a flat log-likelihood surface, for which the algorithm decided that no further improvements were possible and declared convergence. This is an indication that the model may be overparameterized and that you should cut down in the number of parameters." 

<br>

```{r amp_model_bvar_plot2, echo = FALSE, warning = FALSE, fig.height = 8}
# Plot each of the between subject variances for age mixing pattern
# in each of the 100 datasets (by imputation and gender)
bvarplot2 <- modbvar2 %>%
  ggplot(aes(.imp, bsd)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprbsd,
                      ymin = lwrbsd)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 20)) +
  xlab("Imputation") +
  ylab("between-Subject SD (lme4)") +
  theme

bvarplot2
```

<br>

Fraction of between-subject variation differences <= 0 for different alternative hypotheses:

*  Ha: Men have larger between-subject standard errors than women among HIV negative participants: `r gendifbvarprop2`
*  Ha: HIV negative men have larger between-subject standard errors than HIV positive men: `r hivdifmbvarprop2`
*  Ha: HIV negative women have larger between-subject standard errors than HIV positive women: `r hivdifwbvarprop2`

<br>

```{r amp_model_power_plot, echo = FALSE, warning = FALSE, fig.height = 8}

# The formula to calculate the weights for variance is |v|^(2*t)
# I belive t is the power coefficient

powplot <- modpower %>%
  ggplot(aes(.imp, power)) +
  geom_point() +
  geom_pointrange(aes(ymax = uprpow,
                      ymin = lwrpow)) +
  facet_grid(hiv ~ sex) +
  coord_flip() +
  #scale_y_continuous(limits = c(0, 20)) +
  xlab("Imputation") +
  ylab("Power variance function coefficient (nlme)") +
  theme

powplot
```

In the power variance function coefficient plot, there were 20 imputations removed because "Non-positive definite approximate variance-covariance".

```{r age_hiv_fig, include = FALSE, warning = FALSE, fig.height = 8}
# Create dataframe that summarizes the proportion of relationships
# in different partner age groups for people who are HIV
# positive
hivbyage <- impsexhivamp %>%
  unnest() %>%
  ungroup() %>%
  filter(.imp == n & hiv == "Positive") %>%
  group_by(sex, agepgroup) %>%
  summarise(n = n()) %>%
  mutate(prop = round((n / sum(n)) * 100, 2))

# barplot of fraction of relationships in different partner age groups  
hivageplot <- hivbyage %>%
  ggplot(aes(x = agepgroup, y = prop, fill = sex)) +
  geom_bar(stat = "identity",
           position = position_dodge()) +
  xlab("Age group of partner") +
  ylab("Proportion of relationships") +
  scale_fill_brewer(palette = "Dark2") +
  theme

hivageplot
  
```

<br>

### **DO BRIDGEWIDTHS AND SD'S GROW WITH AGE?**

```{r bw_age_sd_setup, include = FALSE}
bwdfm <- partdfimp %>%
  filter(.imp == n) %>%
  filter(sex == "Male") %>%
  select(agegroup, bridgewidth) %>%
  group_by(agegroup) %>%
  summarise(n = n(),
            Mean = round(mean(bridgewidth), 2),
            sd = round(sd(bridgewidth), 2),
            SEM = round((sd/sqrt(n)), 2)) %>%
  rename(SD = sd) %>%
  data.frame(row.names = 1) %>%
  format(nsmall = 1)
  

bwdfw <- partdfimp %>%
  filter(.imp == n) %>%
  filter(sex == "Female") %>%
  select(agegroup, bridgewidth) %>%
  group_by(agegroup) %>%
  summarise(n = n(),
            Mean = round(mean(bridgewidth), 2),
            sd = round(sd(bridgewidth), 2),
            SEM = round((sd/sqrt(n)), 2)) %>%
  rename(SD = sd) %>%
  data.frame(row.names = 1) %>%
  format(nsmall = 1)
  
```

```{r bw_age_sd_table, echo = FALSE}

htmlTable(cbind(bwdfm, bwdfw),
          caption = "<b>Table 1. Mean bridgewidth by age category and gender in randomly selected imputed dataset<b/>",
          ctable = TRUE,
          tfoot = txtMergeLines("SD, Standard Deviation",
                                "SEM, Standard Error of the Mean"),
          cgroup = c("Male", "Female"),
          n.cgroup = c(4,4),
          rowlabel = "Age category")

```


<br>

### **DOES HIV STATUS PREDICT BRIDGEWIDTH?**

<br>

Here I used generalised additive models with negative binomial regression to regress bridgewidths on HIV status of the participant before enterring our study. In these models, the participant is the unit of observation and only participants reporting more than one partner in the previous year were included. Separate models were created for men and women, as well as imputed datasets. The models adjust for age(smooth term) and race. 

<br>

```{r bw_hiv_setup, include = FALSE, warning = FALSE}
# Exclude complete cases dataframe
# Keep only participants with more than one relationship in the past year
impsex <- partdfimp %>% 
  filter(.imp != 0) %>%
  group_by(.imp, sex) 

# Summarize the median and IQR of bW by sex and dataset
# Among those with more than 1 partner
bwbyimpsex <- impsex %>%
  filter(relcount > 1) %>%
  summarise(n = n(),
            Median = median(bridgewidth),
            Mean = mean(bridgewidth),
            sd = sd(bridgewidth),
            lwr = summary(bridgewidth)[[2]],
            upr = summary(bridgewidth)[[5]])

# Nest all the datasets by sex and imputation
impsexbw <- impsex %>% 
  filter(relcount > 1) %>%
  nest()

# Does HIV predict bridgewidths (neg bin models)?
# Does HIV predict whether a participant had a concurrent rel in past year (logistic models)?

tidysum <- impsexbw %>% # A model will be applied to all imputations and sex
  mutate(modelbw = map(data, bwmodel),
         modelsumbw = map(modelbw, tidygam), # Create tidy summary of each model and store as modelsum var in nested df
         predsbwage = map(modelbw, gampredsage)) # Create predictions across dif vals of age (our spline var))

# Unnest the tidy summary, to see the tidy model estimates for each model
bwmodcoef <- tidysum %>%
  unnest(modelsumbw, .drop = TRUE) 

# Unnest the tidy summary, to see the tidy model predictions for values of age
# for each model
bwmodpredage <- tidysum %>%
  unnest(predsbwage, .drop = TRUE)

```



```{r pool_bw_coef, include = FALSE, warning = FALSE}

# Now we want to produce a pooled beta for HIV according to 
# Rubin's rules. To do this we use mice functions

part <- partdfimp %>% # Take original participant-level imputed df
   filter(relcount > 1) %>% # Only participants who had more than one rel
   as.mids() # Create mids object
 
bwmodpoolm <- part %>%
   with(
     gam(bridgewidth ~ hiv + s(age) + race,
         family = nb(),
         subset = (sex == "Male"))
     ) %>%
   pool() %>% # Pool coefficients according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
bwmodpoolw <- part %>%
   with(
     gam(bridgewidth ~ hiv + s(age) + race,
         family = nb(),
         subset = (sex == "Female"))
     ) %>%
   pool() %>% # Pool according to Rubin's Rules
   summary() %>%
   exp() %>%
   round(2) 
 
 menEBWR <- bwmodpoolm[2, 1] # Extract HIV EBWR 
 menEBWRlwr <- bwmodpoolm[2, 6] # Extract HIV lower CI limit
 menEBWRupr <- bwmodpoolm[2, 7] # Extract HIV upper CI limit
 womenEBWR <- bwmodpoolw[2, 1]
 womenEBWRlwr <- bwmodpoolw[2, 6]
 womenEBWRupr <- bwmodpoolw[2, 7]
 
 
```

<br>

###### **Figure 3. Distribution of bridge widths for each imputed dataset, by sex and HIV status.**

<br>

```{r bw_density_fig, echo = FALSE, warning = FALSE}

# Check spread of bridgwidths for each grouped dataset
bwfig <- impsexbw %>%
  unnest() %>%
  ggplot(aes(x = bridgewidth, group = .imp)) +
  geom_density(adjust = 2) +
  facet_grid(hiv ~ sex) +
  xlab("bridgewidth") +
  ylab("Density") +
  theme

bwfig
```


<br>

###### **Figure 4. Model coefficients for relationship between HIV and bridgewidth.**

<br>

```{r bw_hiv_fig, echo = FALSE, warning = FALSE}

ticks <- c(0.5, 1.0, 2.0, 4.0)

 label <- c(
   paste0("Pooled EBWR: ", menEBWR, "(", menEBWRlwr, "-", menEBWRupr, ")"),
   paste0("Pooled EBWR: ", womenEBWR, "(", womenEBWRlwr, "-", womenEBWRupr, ")")
 )

# Plot all the b's for each imputed dataset by sex
# Annotate with the pooled coefficient from above
bwhivfig <- bwmodcoef %>%
  filter(term == "hivPositive") %>%
  ggplot(aes(x = .imp, ratio)) +
   geom_hline(yintercept = 1, 
             color = "blue") +
  geom_point() +
  geom_pointrange(aes(ymax = rupr,
                      ymin = rlwr)) +
  facet_grid(sex ~ .) +
  xlab("Imputation") +
  ylab("Expected Bridge Width Ratio") +
  scale_y_log10(breaks = ticks) +
   annotate("text", x = 40, y = 6.5, label = label) +
  theme

bwhivfig
```


<br>

###### **Figure 5. Expected bridge widths for different values of age (smooth term), by gender.**

<br>

```{r bw_age_fig, echo = FALSE, warning = FALSE}

# Plot expected BW's for different values of age (or spline variable)
# Spaghetti plot to show each line for dataset by gender
bwagefig <- bwmodpredage %>%
  ggplot(aes(x = age, y = pred, group = .imp)) +
  geom_line() +
  facet_grid(. ~ sex) +
  xlab("Age") +
  ylab("Expected Bridge Width") +
  theme

bwagefig

```



```{r close, include = FALSE, warning = FALSE}
# ====================================================
# Detach libraries and remove objects from environment
# ====================================================
Vectorize(detach)(name = paste0("package:", c("tidyverse", "mice", "gamm4",
                                              "mgcv", "modelr", "broom", "nlme", 
                                              "mediation", "MASS", "magrittr")), 
                  unload = TRUE, 
                  character.only = TRUE)

rm(list=ls())

```

